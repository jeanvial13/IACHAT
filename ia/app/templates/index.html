<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Andres Personal IA</title>

  <link rel="stylesheet" href="/static/style.css"/>

  <!-- Syntax highlight para código -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <h1>Andres<br/>Personal IA</h1>

    <button id="new-chat-btn">+ Nuevo chat</button>

    <div class="section">
      <label>Proyectos / Chats</label>
      <div id="chat-list" class="chat-list"></div>
    </div>

    <div class="section">
      <label for="model-select">Modelo</label>
      <select id="model-select">
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="gpt-4o">gpt-4o</option>
      </select>
    </div>

    <div class="section">
      <label>Adjuntar archivos</label>
      <input id="file-input" type="file" multiple/>
      <button id="upload-btn">Subir</button>
      <div id="files-status" class="files-status"></div>
      <div id="file-list" class="file-list"></div>
      <p class="hint small-hint">
        Archivos solo se leerán y resumirán cuando tú lo pidas.
      </p>
    </div>

    <div class="section small">
      <p class="hint">
        • Historial guardado en este navegador<br/>
        • PDFs, TXT y DOCX se pueden leer<br/>
        • Nada de la API key sale del NAS
      </p>
    </div>
  </aside>

  <main class="chat">
    <header class="chat-header">
      <div>
        <strong id="chat-title-label">Chat actual</strong>
        <span id="status" class="status-dot">● Conectado</span>
      </div>
      <button id="clear-btn">Limpiar chat</button>
    </header>

    <div id="chat-log" class="chat-log"></div>

    <form id="chat-form" class="chat-input-area">
      <textarea id="chat-input" placeholder="Escribe tu mensaje aquí..." rows="1"></textarea>
      <button type="submit" id="send-btn">Enviar</button>
    </form>
  </main>
</div>

<script>
  // ---------- Estado global ----------
  const chatLog = document.getElementById("chat-log");
  const input = document.getElementById("chat-input");
  const form = document.getElementById("chat-form");
  const clearBtn = document.getElementById("clear-btn");
  const newChatBtn = document.getElementById("new-chat-btn");
  const modelSelect = document.getElementById("model-select");
  const filesStatus = document.getElementById("files-status");
  const fileInput = document.getElementById("file-input");
  const uploadBtn = document.getElementById("upload-btn");
  const fileList = document.getElementById("file-list");
  const chatList = document.getElementById("chat-list");
  const chatTitleLabel = document.getElementById("chat-title-label");

  let chats = [];         // [{id, title, createdAt, messages: [{role,content}]}]
  let currentChatId = null;
  let uploadedFiles = []; // [{id, filename, stored_name}]

  const STORAGE_KEY = "andres_personal_ia_chats_v1";

  // ---------- Utilidades ----------
  function saveChats() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
  }

  function loadChats() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch (e) {
      console.error("Error cargando chats", e);
      return [];
    }
  }

  function getCurrentChat() {
    return chats.find(c => c.id === currentChatId) || null;
  }

  function setCurrentChat(id) {
    currentChatId = id;
    const chat = getCurrentChat();
    if (!chat) return;

    chatTitleLabel.innerText = chat.title || "Chat actual";
    // Re-render mensajes
    chatLog.innerHTML = "";
    chat.messages.forEach(m => appendMessage(m.role, m.content, {save:false}));
  }

  function createNewChat(title) {
    const id = Date.now().toString();
    const chat = {
      id,
      title: title || ("Chat " + new Date().toLocaleString()),
      createdAt: Date.now(),
      messages: []
    };
    chats.push(chat);
    saveChats();
    renderChatList();
    currentChatId = id;
    chatLog.innerHTML = "";
    chatTitleLabel.innerText = chat.title;
    appendMessage("assistant", "Nuevo chat iniciado. ¿En qué te ayudo?", {save:true});
  }

  function renderChatList() {
    chatList.innerHTML = "";
    chats
      .sort((a, b) => b.createdAt - a.createdAt)
      .forEach(chat => {
        const btn = document.createElement("button");
        btn.className = "chat-list-item" + (chat.id === currentChatId ? " active" : "");
        btn.innerText = chat.title;
        btn.onclick = () => {
          currentChatId = chat.id;
          setCurrentChat(chat.id);
          renderChatList();
        };
        chatList.appendChild(btn);
      });
  }

  function renderFileList() {
    fileList.innerHTML = "";
    if (!uploadedFiles.length) return;
    uploadedFiles.forEach(f => {
      const row = document.createElement("div");
      row.className = "file-item";

      const nameSpan = document.createElement("span");
      nameSpan.className = "file-name";
      nameSpan.innerText = f.filename;

      const btn = document.createElement("button");
      btn.className = "file-btn";
      btn.innerText = "Resumir";
      btn.onclick = () => summarizeFile(f);

      row.appendChild(nameSpan);
      row.appendChild(btn);
      fileList.appendChild(row);
    });
  }

  function escapeHtml(str) {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function renderTextWithCode(text) {
    // Escapar HTML
    let escaped = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    // ```lang\ncode\n``` -> <pre><code class="language-lang">...</code></pre>
    escaped = escaped.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
      const language = lang || "plaintext";
      const safeCode = code
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      return `<pre><code class="language-${language}">${safeCode}</code></pre>`;
    });

    // Saltos de línea normales
    return escaped.replace(/\n/g, "<br/>");
  }

  function appendMessage(role, text, options = {save:true}) {
    const wrapper = document.createElement("div");
    wrapper.className = "msg " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    if (role === "assistant") {
      bubble.innerHTML = renderTextWithCode(text);
    } else {
      bubble.innerText = text;
    }

    wrapper.appendChild(bubble);
    chatLog.appendChild(wrapper);
    chatLog.scrollTop = chatLog.scrollHeight;

    if (options.save) {
      const chat = getCurrentChat();
      if (chat) {
        chat.messages.push({role, content: text});
        saveChats();
      }
    }

    if (role === "assistant") {
      document.querySelectorAll("pre code").forEach(el => {
        try {
          window.hljs && window.hljs.highlightElement(el);
        } catch (e) {}
      });
    }
  }

  async function sendMessage(message) {
    if (!message) return;
    appendMessage("user", message, {save:true});

    appendMessage("assistant", "Pensando...", {save:false});
    const thinkingNode = chatLog.lastChild;

    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          message,
          history: getCurrentChat()?.messages || [],
          model: modelSelect.value
        })
      });

      const data = await res.json();
      chatLog.removeChild(thinkingNode);

      if (data.reply) {
        appendMessage("assistant", data.reply, {save:true});
      } else {
        appendMessage("assistant", "⚠️ " + (data.error || "Error desconocido"), {save:true});
      }
    } catch (err) {
      chatLog.removeChild(thinkingNode);
      appendMessage("assistant", "⚠️ Error de conexión: " + err, {save:true});
    }
  }

  async function uploadFiles() {
    const files = fileInput.files;
    if (!files || !files.length) {
      filesStatus.innerText = "Selecciona uno o más archivos primero.";
      return;
    }
    filesStatus.innerText = "Subiendo archivos...";
    const fd = new FormData();
    for (const f of files) {
      fd.append("files", f);
    }
    try {
      const res = await fetch("/upload", {
        method: "POST",
        body: fd
      });
      const data = await res.json();
      if (data.files) {
        uploadedFiles = data.files;
        filesStatus.innerText = "Archivos subidos. Usa el botón 'Resumir' cuando quieras leerlos.";
        renderFileList();
      } else {
        filesStatus.innerText = "Error: " + (data.error || "No se pudieron subir los archivos.");
      }
    } catch (err) {
      filesStatus.innerText = "Error subiendo archivos: " + err;
    }
  }

  async function summarizeFile(fileInfo) {
    filesStatus.innerText = "Leyendo " + fileInfo.filename + "...";
    try {
      const res = await fetch("/summarize_file", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          stored_name: fileInfo.stored_name,
          filename: fileInfo.filename,
          model: modelSelect.value
        })
      });
      const data = await res.json();
      filesStatus.innerText = "Resumen recibido.";
      if (data.summary) {
        const msg = "Resumen de " + data.filename + ":\n" + data.summary;
        appendMessage("assistant", msg, {save:true});
      } else if (data.error) {
        appendMessage("assistant", "⚠️ " + data.error, {save:true});
      }
    } catch (err) {
      filesStatus.innerText = "Error resumiendo archivo: " + err;
      appendMessage("assistant", "⚠️ Error resumiendo archivo: " + err, {save:true});
    }
  }

  // ---------- Eventos ----------
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    sendMessage(text);
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      form.dispatchEvent(new Event("submit"));
    }
  });

  clearBtn.addEventListener("click", () => {
    const chat = getCurrentChat();
    if (!chat) return;
    chat.messages = [];
    saveChats();
    chatLog.innerHTML = "";
  });

  newChatBtn.addEventListener("click", () => {
    const title = prompt("Nombre del proyecto / chat:", "Nuevo proyecto");
    createNewChat(title || "Nuevo proyecto");
    renderChatList();
  });

  uploadBtn.addEventListener("click", () => {
    uploadFiles();
  });

  // ---------- Inicialización ----------
  document.addEventListener("DOMContentLoaded", () => {
    chats = loadChats();
    if (!chats.length) {
      createNewChat("Proyecto inicial");
    } else {
      // usar el más reciente
      chats.sort((a, b) => b.createdAt - a.createdAt);
      currentChatId = chats[0].id;
      setCurrentChat(currentChatId);
    }
    renderChatList();
    renderFileList();
    try {
      window.hljs && window.hljs.highlightAll();
    } catch (e) {}
  });
</script>
</body>
</html>
