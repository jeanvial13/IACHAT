<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Andres IA</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <h1>IA Andres</h1>
    <button id="new-chat-btn">+ Nuevo chat</button>

    <div class="section">
      <label for="model-select">Modelo</label>
      <select id="model-select">
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="gpt-4o">gpt-4o</option>
      </select>
    </div>

    <div class="section">
 <div class="section">
  <label>Adjuntar archivos</label>

  <div class="file-upload-wrapper">
    <button type="button" class="file-upload-btn">üìÅ Seleccionar archivo</button>
    <input id="file-input" type="file" multiple />
  </div>

  <div id="selected-file-name">Ning√∫n archivo seleccionado</div>

  <button id="upload-btn">Subir & resumir</button>
</div>


    <!-- üî• Nuevo bot√≥n para ver consumo de tokens -->
    <div class="section">
      <a href="https://platform.openai.com/usage" target="_blank" class="token-usage-btn">
        ‚ö° Consumo de Tokens OpenAI
      </a>
    </div>

    <div class="section small">
      <p class="hint">
        <div class="quotes">
  <p>‚ÄúHazlo por los que ya no est√°n‚Ä¶‚Äù</p>
  <p>‚ÄúNo necesito suerte. Solo necesito avanzar.‚Äù</p>
  <p>‚ÄúSi el camino es peligroso, vale la pena.‚Äù</p>
  <p>‚ÄúNo vine a ser uno m√°s. Vine a romper la l√≠nea.‚Äù</p>
</div>
      </p>
    </div>
  </aside>
  <div class="holo-arrow"></div>

  <main class="chat">
    <header class="chat-header">
      <div>
        <strong>Chat actual</strong>
        <span id="status" class="status-dot">‚óè Conectado</span>
      </div>
      <button id="clear-btn">Limpiar chat</button>
    </header>

    <div id="chat-log" class="chat-log"></div>

    <form id="chat-form" class="chat-input-area">
      <textarea id="chat-input" placeholder="Escribe tu mensaje aqu√≠..." rows="1"></textarea>
      <button type="submit" id="send-btn">Enviar</button>
    </form>
  </main>
</div>

<script>
  const chatLog = document.getElementById("chat-log");
  const input = document.getElementById("chat-input");
  const form = document.getElementById("chat-form");
  const clearBtn = document.getElementById("clear-btn");
  const newChatBtn = document.getElementById("new-chat-btn");
  const modelSelect = document.getElementById("model-select");
  const fileInput = document.getElementById("file-input");
  const uploadBtn = document.getElementById("upload-btn");
  const filesStatus = document.getElementById("files-status");

  let history = [];
  let fileSummaries = [];

  function appendMessage(role, text) {
    const wrapper = document.createElement("div");
    wrapper.className = "msg " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerText = text;

    wrapper.appendChild(bubble);
    chatLog.appendChild(wrapper);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  async function sendMessage(message) {
    if (!message) return;
    appendMessage("user", message);
    history.push({ role: "user", content: message });

    appendMessage("assistant", "Pensando...");
    const thinkingNode = chatLog.lastChild;

    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message,
          history,
          model: modelSelect.value,
          file_summaries: fileSummaries
        })
      });

      const data = await res.json();
      chatLog.removeChild(thinkingNode);

      if (data.reply) {
        appendMessage("assistant", data.reply);
        history.push({ role: "assistant", content: data.reply });
      } else {
        appendMessage("assistant", "‚ö†Ô∏è " + (data.error || "Error desconocido"));
      }
    } catch (err) {
      chatLog.removeChild(thinkingNode);
      appendMessage("assistant", "‚ö†Ô∏è Error de conexi√≥n: " + err);
    }
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    sendMessage(text);
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      form.dispatchEvent(new Event("submit"));
    }
  });

  clearBtn.addEventListener("click", () => {
    history = [];
    fileSummaries = [];
    chatLog.innerHTML = "";
  });

  newChatBtn.addEventListener("click", () => {
    history = [];
    fileSummaries = [];
    chatLog.innerHTML = "";
    appendMessage("assistant", "Nuevo chat iniciado. ¬øEn qu√© te ayudo?");
  });

  uploadBtn.addEventListener("click", async () => {
    const files = fileInput.files;
    if (!files || !files.length) {
      filesStatus.innerText = "Selecciona uno o m√°s archivos primero.";
      return;
    }
    filesStatus.innerText = "Subiendo y resumiendo archivos...";
    const fd = new FormData();
    for (const f of files) {
      fd.append("files", f);
    }
    try {
      const res = await fetch("/upload", {
        method: "POST",
        body: fd
      });
      const data = await res.json();
      if (data.files) {
        fileSummaries = data.files;
        filesStatus.innerText = "Archivos listos. El contexto se usar√° en tus pr√≥ximas preguntas.";
        data.files.forEach(f => {
          appendMessage("assistant", "Resumen de " + f.filename + ":\n" + f.summary);
          history.push({ role: "assistant", content: "Resumen de " + f.filename + ":\n" + f.summary });
        });
      } else {
        filesStatus.innerText = "Error: " + (data.error || "No se pudieron procesar los archivos.");
      }
    } catch (err) {
      filesStatus.innerText = "Error subiendo archivos: " + err;
    }
  });

  // Mensaje inicial
  appendMessage("assistant", "¬°Bienvenido, choom‚Ä¶ prep√°rate! Las leyendas no nacen‚Ä¶ se ejecutan. Iniciando protocolo Andres.");

  // Mostrar nombre de archivo elegido
const fileInput2 = document.getElementById("file-input");
const fileNameText = document.getElementById("selected-file-name");

fileInput2.addEventListener("change", () => {
  if (fileInput2.files.length === 0) {
    fileNameText.innerText = "Ning√∫n archivo seleccionado";
  } else if (fileInput2.files.length === 1) {
    fileNameText.innerText = fileInput2.files[0].name;
  } else {
    fileNameText.innerText = `${fileInput2.files.length} archivos seleccionados`;
  }
});
  <script>
document.addEventListener("mousemove", (e) => {
    const g = document.createElement("div");
    g.classList.add("ghost");
    g.style.left = e.pageX + "px";
    g.style.top = e.pageY + "px";
    document.body.appendChild(g);
    setTimeout(() => g.remove(), 600);
});
</script>


</script>
  

</body>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
  <div class="particle" style="left:5%; top:10%;"></div>
<div class="particle" style="left:12%; top:40%;"></div>
<div class="particle" style="left:20%; top:80%;"></div>
<div class="particle" style="left:28%; top:30%;"></div>
<div class="particle" style="left:35%; top:60%;"></div>
<div class="particle" style="left:42%; top:15%;"></div>
<div class="particle" style="left:48%; top:55%;"></div>
<div class="particle" style="left:52%; top:72%;"></div>
<div class="particle" style="left:58%; top:22%;"></div>
<div class="particle" style="left:65%; top:45%;"></div>
<div class="particle" style="left:72%; top:75%;"></div>
<div class="particle" style="left:80%; top:20%;"></div>
<div class="particle" style="left:88%; top:50%;"></div>
<div class="particle" style="left:95%; top:30%;"></div><div class="particle" style="left:5%; top:10%;"></div>
<div class="particle" style="left:12%; top:40%;"></div>
<div class="particle" style="left:20%; top:80%;"></div>
<div class="particle" style="left:28%; top:30%;"></div>
<div class="particle" style="left:35%; top:60%;"></div>
<div class="particle" style="left:42%; top:15%;"></div>
<div class="particle" style="left:48%; top:55%;"></div>
<div class="particle" style="left:52%; top:72%;"></div>
<div class="particle" style="left:58%; top:22%;"></div>
<div class="particle" style="left:65%; top:45%;"></div>
<div class="particle" style="left:72%; top:75%;"></div>
<div class="particle" style="left:80%; top:20%;"></div>
<div class="particle" style="left:88%; top:50%;"></div>
<div class="particle" style="left:95%; top:30%;"></div><div class="particle" style="left:5%; top:10%;"></div>
<div class="particle" style="left:12%; top:40%;"></div>
<div class="particle" style="left:20%; top:80%;"></div>
<div class="particle" style="left:28%; top:30%;"></div>
<div class="particle" style="left:35%; top:60%;"></div>
<div class="particle" style="left:42%; top:15%;"></div>
<div class="particle" style="left:48%; top:55%;"></div>
<div class="particle" style="left:52%; top:72%;"></div>
<div class="particle" style="left:58%; top:22%;"></div>
<div class="particle" style="left:65%; top:45%;"></div>
<div class="particle" style="left:72%; top:75%;"></div>
<div class="particle" style="left:80%; top:20%;"></div>
<div class="particle" style="left:88%; top:50%;"></div>
<div class="particle" style="left:95%; top:30%;"></div><div class="particle" style="left:5%; top:10%;"></div>
<div class="particle" style="left:12%; top:40%;"></div>
<div class="particle" style="left:20%; top:80%;"></div>
<div class="particle" style="left:28%; top:30%;"></div>
<div class="particle" style="left:35%; top:60%;"></div>
<div class="particle" style="left:42%; top:15%;"></div>
<div class="particle" style="left:48%; top:55%;"></div>
<div class="particle" style="left:52%; top:72%;"></div>
<div class="particle" style="left:58%; top:22%;"></div>
<div class="particle" style="left:65%; top:45%;"></div>
<div class="particle" style="left:72%; top:75%;"></div>
<div class="particle" style="left:80%; top:20%;"></div>
<div class="particle" style="left:88%; top:50%;"></div>
<div class="particle" style="left:95%; top:30%;"></div><div class="particle" style="left:5%; top:10%;"></div>
<div class="particle" style="left:12%; top:40%;"></div>
<div class="particle" style="left:20%; top:80%;"></div>
<div class="particle" style="left:28%; top:30%;"></div>
<div class="particle" style="left:35%; top:60%;"></div>
<div class="particle" style="left:42%; top:15%;"></div>
<div class="particle" style="left:48%; top:55%;"></div>
<div class="particle" style="left:52%; top:72%;"></div>
<div class="particle" style="left:58%; top:22%;"></div>
<div class="particle" style="left:65%; top:45%;"></div>
<div class="particle" style="left:72%; top:75%;"></div>
<div class="particle" style="left:80%; top:20%;"></div>
<div class="particle" style="left:88%; top:50%;"></div>
<div class="particle" style="left:95%; top:30%;"></div>

</html>
