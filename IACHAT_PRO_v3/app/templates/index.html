<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IACHAT_PRO v3</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
      background: #000;
      color: #00ff88;
      font-family: "Courier New", monospace;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      border-bottom: 1px solid #00ff88;
      padding: 10px;
      font-weight: bold;
      text-align: center;
    }
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #00ff88;
      margin: 10px;
      border-radius: 8px;
      background: #010a01;
    }
    #input-area {
      display: flex;
      align-items: center;
      padding: 10px;
      border-top: 1px solid #00ff88;
      background: #000;
      gap: 8px;
    }
    textarea {
      flex: 1;
      background: #000;
      border: 1px solid #00ff88;
      color: #00ff88;
      padding: 10px;
      font-size: 14px;
      border-radius: 5px;
      resize: none;
      overflow-y: hidden;
      font-family: "Courier New", monospace;
    }
    button {
      background: #00ff88;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      cursor: pointer;
    }
    button:hover {
      background: #22ffaa;
    }
    .msg {
      margin-bottom: 10px;
      white-space: pre-wrap;
    }
    .user { color: #00ff88; text-align: right; }
    .assistant { color: #fff; text-align: left; }
    #toolbar {
      display: flex;
      justify-content: flex-end;
      padding: 6px;
      border-bottom: 1px solid #00ff88;
      background: #020c02;
      gap: 10px;
    }
    #toolbar button {
      background: none;
      color: #00ff88;
      border: 1px solid #00ff88;
      border-radius: 4px;
      font-size: 13px;
    }
    #toolbar button:hover {
      background: #00ff88;
      color: #000;
    }
  </style>
</head>

<body>
  <header>IACHAT_PRO v3 :: online</header>

  <div id="toolbar">
    <button id="btn-new">+ Nuevo</button>
    <button id="btn-export">üíæ Exportar</button>
    <button id="btn-credits">üí≥ Cr√©ditos</button>
  </div>

  <div id="chat-box">
    <div># Proyecto cargado. Usa /help para ver comandos. Auto-save cada 30s.</div>
  </div>

  <div id="input-area">
    <input type="file" id="file-input" multiple style="color:#00ff88;">
    <button id="btn-upload">upload</button>
    <textarea id="msg" rows="1" placeholder="Escribe tu mensaje... (Shift+Enter para nueva l√≠nea)"></textarea>
    <button id="send-btn">‚û§</button>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("send-btn");
    const uploadBtn = document.getElementById("btn-upload");
    const fileInput = document.getElementById("file-input");

    // Enviar mensaje con Enter
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Ajuste din√°mico de altura
    input.addEventListener("input", () => {
      input.style.height = "auto";
      input.style.height = input.scrollHeight + "px";
    });

    sendBtn.addEventListener("click", sendMessage);

    function appendMessage(sender, text) {
      const div = document.createElement("div");
      div.classList.add("msg", sender);
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;
      appendMessage("user", msg);
      input.value = "";
      input.style.height = "auto";
      appendMessage("assistant", "‚Ä¶");
      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg }),
        });
        const data = await res.json();
        typeWriter(data.reply);
      } catch (e) {
        appendMessage("assistant", "‚ö†Ô∏è Error de conexi√≥n con el servidor");
      }
    }

    // Animaci√≥n de escritura tipo ChatGPT
    function typeWriter(text) {
      const last = document.querySelector(".assistant:last-child");
      last.textContent = "";
      let i = 0;
      const timer = setInterval(() => {
        last.textContent += text.charAt(i);
        chatBox.scrollTop = chatBox.scrollHeight;
        i++;
        if (i >= text.length) clearInterval(timer);
      }, 20);
    }

    // Upload
    uploadBtn.addEventListener("click", async () => {
      const files = fileInput.files;
      if (!files.length) {
        appendMessage("assistant", "# No se seleccion√≥ ning√∫n archivo");
        return;
      }
      const form = new FormData();
      for (let f of files) form.append("file", f);
      appendMessage("user", `Subiendo ${files.length} archivo(s)...`);
      try {
        const res = await fetch("/upload", { method: "POST", body: form });
        const data = await res.json();
        if (data.zip) {
          appendMessage("assistant", `Archivo ZIP listo: ${data.zip}`);
        } else {
          appendMessage("assistant", "‚ö†Ô∏è Error al generar ZIP");
        }
      } catch {
        appendMessage("assistant", "‚ö†Ô∏è Error en la conexi√≥n durante la subida");
      }
    });
  </script>
</body>
</html>
