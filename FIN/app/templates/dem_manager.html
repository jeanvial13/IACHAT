<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Manager</title>
  <link rel="stylesheet" href="/static/style.css" />

  <style>
    .modal .modal-content.neon-pop {
      animation: neonPop 0.35s ease-out;
    }

    @keyframes neonPop {
      0% { transform: scale(0.85); opacity: 0; }
      60% { transform: scale(1.03); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .dem-note-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle, #ff5c9f 0%, #ff003c 45%, transparent 70%);
      animation: pulseGlow 1.4s infinite;
    }

    @keyframes pulseGlow {
      0% { transform: scale(0.9); }
      50% { transform: scale(1.2); }
      100% { transform: scale(0.9); }
    }

    .notes-timeline-box {
      padding: 8px 10px;
      background: rgba(70,10,90,0.4);
      border-radius: 10px;
      margin-top: 12px;
    }

    .note-item {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
      padding: 4px 0;
    }

    .note-actions {
      display: flex;
      gap: 6px;
    }

    .edit-note-btn,
    .delete-note-btn {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 6px;
      cursor: pointer;
      background: rgba(255,255,255,0.1);
    }

    .delete-note-btn {
      background: rgba(255,0,80,0.3);
    }

    .delete-note-btn:hover {
      background: red;
    }
  </style>
</head>

<body>
<!-- MODAL PARA NUEVO / EDITAR PROYECTO (ahora s√≠ colocado dentro del <body>) -->
<div id="project-modal" class="modal hidden">
  <div class="modal-content">
    <h2 id="modal-title">New Project</h2>

    <form id="project-form">
      <div class="form-grid">

        <label>Project Name
          <input type="text" name="name" required />
        </label>

        <label>Sponsor
          <input type="text" name="sponsor" />
        </label>

        <label>Requester
          <input type="text" name="requester" />
        </label>

        <label>BA Owner
          <input type="text" name="ba_owner" />
        </label>

        <label>Project Title
          <input type="text" name="title" />
        </label>

        <label>Change Requested
          <input type="text" name="change_request" />
        </label>

        <label>Cost Center
          <input type="text" name="cost_center" />
        </label>

        <label>Status
          <select name="status">
            <option>Specific Requirements</option>
            <option>Business Case Creation</option>
            <option>Review/Cost Estimation</option>
            <option>Regional Business Center</option>
            <option>Business Operations Approval</option>
            <option>Functional Design</option>
            <option>SOW Request</option>
            <option>Budget Approval</option>
            <option>CLM Request</option>
            <option>Create CSR/PO</option>
            <option>Change Request in Progress</option>
            <option>Cancel</option>
            <option>Closed</option>
          </select>
        </label>

        <label>Workflow Status
          <select name="workflow_status">
            <option>Pending Est. Approval</option>
            <option>Pending SOW</option>
            <option>Pending CCB Review</option>
            <option>CLM Process</option>
            <option>Development</option>
            <option>Development Queue</option>
            <option>IT Testing</option>
            <option>Dev Business Testing</option>
            <option>Migration UAT</option>
            <option>Migration PROD</option>
            <option>IT Review</option>
            <option>IT MGR Approval</option>
            <option>Rejected</option>
            <option>Closed</option>
            <option>In Production</option>
          </select>
        </label>

        <label>Current Task Owner
          <input type="text" name="current_owner" />
        </label>

        <label>Start Date
          <input type="date" name="start_date" />
        </label>

      </div>

      <div class="modal-actions">
        <button type="button" id="cancel-modal">Cancel</button>
        <button type="submit" id="save-project">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- APP LAYOUT -->
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <h1>Project Manager</h1>

    <button type="button" onclick="window.location.href='/'">‚Üê Back to Chat</button>

    <div class="section">
      <p class="hint">
        Gestiona todos tus DEM / proyectos con contexto, notas, SLA y documentos en un solo lugar.
      </p>
    </div>

    <div class="section small">
      <div class="quotes">
        <p>‚ÄúProjects gain power when they stay visible.‚Äù</p>
        <p>‚ÄúClarity, ownership and follow-up keep change alive.‚Äù</p>
      </div>
    </div>
  </aside>

  <div class="holo-arrow"></div>

  <!-- Main content -->
  <main class="chat">

    <header class="chat-header">
      <div>
        <strong>Project Manager Portfolio</strong>
        <span id="dems-notifications" class="status-dot">‚óè Monitoring</span>
      </div>
    </header>

    <div class="dems-layout">

      <!-- Toolbar -->
      <div class="dems-toolbar">

        <div class="dems-toolbar-top">
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="create-project-btn" type="button" class="btn-cyber">‚ú¶ New Project</button>

            <div class="dems-tabs">
              <button type="button" class="dems-tab active" data-tab="active">Active DEMs</button>
              <button type="button" class="dems-tab" data-tab="archived">Archived DEMs</button>
            </div>
          </div>

          <div class="dems-download-group">
            <button id="generate-report-btn" type="button">üìÑ Generate Portfolio Report</button>
            <button id="download-txt-btn" type="button">‚¨á TXT</button>
            <button id="download-docx-btn" type="button">‚¨á DOCX</button>
            <button id="download-pdf-btn" type="button">‚¨á PDF</button>
          </div>
        </div>

        <div class="dems-search-row">
          <input id="dems-search" type="text" placeholder="Search DEMs by name, owner, status, notes, etc..." />
        </div>

        <div id="dem-chip-bar" class="dem-chip-bar"></div>
      </div>

      <!-- Project Section -->
      <section class="dems-projects-section">
        <h2>Projects</h2>
        <div id="dems-projects" class="dems-projects"></div>
      </section>

      <!-- Portfolio Report -->
      <section class="dems-report-section">
        <h2>Portfolio Report</h2>
        <div id="dem-report-output">
          Click "Generate Portfolio Report" to build a fresh executive summary.
        </div>
      </section>

    </div>
  </main>
</div>

<!-- Floating particles for cyberpunk effect 
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div> -->

  <script>
/* ========================
   VARIABLES Y REFERENCIAS
======================== */

const createProjectBtn = document.getElementById('create-project-btn');
const generateReportBtn = document.getElementById('generate-report-btn');
const downloadTxtBtn = document.getElementById('download-txt-btn');
const downloadDocxBtn = document.getElementById('download-docx-btn');
const downloadPdfBtn = document.getElementById('download-pdf-btn');
const projectsContainer = document.getElementById('dems-projects');
const notif = document.getElementById('dems-notifications');
const reportOutput = document.getElementById('dem-report-output');
const searchInput = document.getElementById('dems-search');
const chipBar = document.getElementById('dem-chip-bar');
const tabs = document.querySelectorAll('.dems-tab');

let activeProjects = [];
let archivedProjects = [];
let currentTab = 'active';
let searchText = '';

/* ========================
      MODAL FORM
======================== */

function openProjectForm(existing) {
  const modal = document.getElementById("project-modal");
  const form = document.getElementById("project-form");
  const title = document.getElementById("modal-title");

  modal.classList.remove("hidden");

  const content = modal.querySelector(".modal-content");
  content.classList.add("neon-pop");
  content.addEventListener(
    "animationend",
    () => content.classList.remove("neon-pop"),
    { once: true }
  );

  form.reset();

  if (existing) {
    title.textContent = "Edit Project";
    for (const k in existing) {
      if (form[k]) form[k].value = existing[k];
    }
  } else {
    title.textContent = "New Project";
  }

  return new Promise((resolve) => {
    form.onsubmit = (e) => {
      e.preventDefault();
      modal.classList.add("hidden");
      const data = Object.fromEntries(new FormData(form));
      resolve(data);
    };

    document.getElementById("cancel-modal").onclick = () => {
      modal.classList.add("hidden");
      resolve(null);
    };
  });
}

/* ========================
      CREATE PROJECT
======================== */

createProjectBtn.addEventListener("click", async () => {
  const payload = await openProjectForm(null);
  if (!payload) return;

  try {
    const res = await fetch("/api/dems/projects", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const data = await res.json();

    if (data.project) {
      activeProjects.push(data.project);
      renderAll();
    } else {
      alert("Error creating project: " + (data.error || "Unknown error"));
    }
  } catch (err) {
    alert("Connection error creating DEM: " + err);
  }
});

/* ========================
     GENERATE REPORT
======================== */

generateReportBtn.addEventListener("click", async () => {
  reportOutput.textContent = "Generating report...";

  try {
    const res = await fetch("/api/dems/report", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    });

    const data = await res.json();
    reportOutput.textContent = data.report || "Error";
  } catch (err) {
    reportOutput.textContent = "Connection error: " + err;
  }
});

/* ========================
      DOWNLOAD REPORTS
======================== */

async function downloadReport(format) {
  try {
    const res = await fetch(`/api/dems/download/${format}`);

    if (!res.ok) {
      alert("Error downloading report");
      return;
    }

    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `dems_portfolio.${format}`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  } catch (err) {
    alert("Connection error: " + err);
  }
}

downloadTxtBtn.addEventListener("click", () => downloadReport("txt"));
downloadDocxBtn.addEventListener("click", () => downloadReport("docx"));
downloadPdfBtn.addEventListener("click", () => downloadReport("pdf"));

/* ========================
         TABS
======================== */

tabs.forEach((tab) =>
  tab.addEventListener("click", () => {
    tabs.forEach((t) => t.classList.remove("active"));
    tab.classList.add("active");
    currentTab = tab.dataset.tab;
    renderAll();
  })
);

/* ========================
        SEARCH
======================== */

searchInput.addEventListener("input", () => {
  searchText = searchInput.value.toLowerCase();
  renderAll();
});

/* ========================
  PROJECT RENDERING CORE
======================== */

function getCurrentList() {
  return currentTab === "active" ? activeProjects : archivedProjects;
}

function filterBySearch(list) {
  if (!searchText) return list;

  return list.filter((p) => {
    const fields = [
      p.name,
      p.title,
      p.sponsor,
      p.requester,
      p.ba_owner,
      p.cost_center,
      p.status,
      p.workflow_status,
      p.current_owner,
      p.last_note,
      (p.notes || [])
        .map((n) => (typeof n === "string" ? n : `${n.date} ${n.text}`))
        .join(" "),
    ]
      .join(" ")
      .toLowerCase();

    return fields.includes(searchText);
  });
}

function buildChips(list) {
  chipBar.innerHTML = "";

  list.forEach((p) => {
    const chip = document.createElement("button");
    chip.type = "button";
    chip.className = "dem-chip";
    chip.textContent = p.name || "(No name)";

    chip.addEventListener("click", () => {
      const card = document.querySelector(`.dem-card[data-id="${p.id}"]`);
      if (card) {
        document
          .querySelectorAll(".dem-chip")
          .forEach((c) => c.classList.remove("active"));

        chip.classList.add("active");

        card.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    });

    chipBar.appendChild(chip);
  });
}

/* ========================
   RENDER PROJECT CARDS
======================== */

function renderProjects(list) {
  projectsContainer.innerHTML = "";

  if (!list.length) {
    projectsContainer.innerHTML = `<p class="hint">No projects in this view.</p>`;
    return;
  }

  list.forEach((p) => {
    const card = document.createElement("article");
    card.className = "dem-card";
    card.dataset.id = p.id;

    /* HEADER */
    const header = document.createElement("div");
    header.className = "dem-card-header";
    header.innerHTML = `
      <div>
        <h3>${p.name}</h3>
        <p class="dem-subtitle">
          ${p.title || ""}
          ${p.last_note ? `<span class="dem-note-dot"></span>` : ""}
        </p>
      </div>

      <div class="dem-tags">
        <span class="dem-tag primary">${p.status}</span>
        <span class="dem-tag">${p.workflow_status}</span>
        <span class="dem-tag ${p.sla_breached ? "sla-breached" : "sla-ok"}">
          ${p.sla_breached ? "SLA Breached" : "SLA OK"}
        </span>
      </div>
    `;
    card.appendChild(header);

    /* META */
    const meta = document.createElement("div");
    meta.className = "dem-meta";
    meta.innerHTML = `
      <p><strong>Sponsor:</strong> ${p.sponsor}</p>
      <p><strong>Requester:</strong> ${p.requester}</p>
      <p><strong>BA Owner:</strong> ${p.ba_owner}</p>
      <p><strong>Current Owner:</strong> ${p.current_owner}</p>
      <p><strong>Cost Center:</strong> ${p.cost_center}</p>
      <p><strong>Start Date:</strong> ${p.start_date}</p>
    `;
    card.appendChild(meta);

    /* LAST NOTE */
    const lastNote = document.createElement("div");
    lastNote.className = "dem-last-note";
    lastNote.innerHTML = `
      <strong>Last Note:</strong>
      <p>${p.last_note || "No notes"}</p>
    `;
    card.appendChild(lastNote);

    /* NOTES TIMELINE (CON EDITAR/ELIMINAR) */
    if (p.notes && p.notes.length) {
      const notesBox = document.createElement("div");
      notesBox.className = "notes-timeline-box";

      notesBox.innerHTML = `
        <div class="notes-title">‚ú¶ Notes Timeline (Newest First)</div>
      `;

      const ul = document.createElement("ul");
      ul.className = "notes-timeline-list";

      p.notes
        .map((n, i) => ({ data: n, index: i }))
        .reverse()
        .forEach((note) => {
          const li = document.createElement("li");
          li.className = "note-item";

          const text =
            typeof note.data === "string"
              ? note.data
              : `[${note.data.date}] ‚Äî ${note.data.text}`;

          li.innerHTML = `
            <span>${text}</span>
            <div class="note-actions">
              <button class="edit-note-btn">‚úé</button>
              <button class="delete-note-btn">üóë</button>
            </div>
          `;

          li.querySelector(".edit-note-btn").addEventListener("click", () =>
            editNote(p.id, note.index, text)
          );

          li.querySelector(".delete-note-btn").addEventListener("click", () =>
            deleteNote(p.id, note.index)
          );

          ul.appendChild(li);
        });

      notesBox.appendChild(ul);
      card.appendChild(notesBox);
    }

    /* SLA BANNER */
    const banner = document.createElement("div");
    banner.className = `dem-sla-banner ${
      p.sla_breached ? "breached" : "ok"
    }`;
    banner.textContent = p.sla_breached
      ? "SLA Breached ‚Äì Check immediately"
      : "SLA OK ‚Äì Project updated recently.";
    card.appendChild(banner);

    /* ACTION BUTTONS */
    const actions = document.createElement("div");
    actions.className = "dem-actions";

    const addNoteBtn = document.createElement("button");
    addNoteBtn.textContent = "Add Note";
    addNoteBtn.onclick = () => addNote(p.id);

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit Project";
    editBtn.onclick = () => editProject(p.id);

    const archiveBtn = document.createElement("button");
    archiveBtn.textContent = p.archived ? "Restore" : "Archive";
    archiveBtn.onclick = () => toggleArchive(p.id, p.archived);

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.classList.add("danger");
    deleteBtn.onclick = () => deleteProject(p.id);

    actions.appendChild(addNoteBtn);
    actions.appendChild(editBtn);
    actions.appendChild(archiveBtn);
    actions.appendChild(deleteBtn);

    card.appendChild(actions);

    projectsContainer.appendChild(card);
  });
}

/* ========================
        NOTE HANDLERS
======================== */

async function addNote(projectId) {
  const text = prompt("Enter note:");
  if (!text) return;

  try {
    const timestamp = new Date()
      .toISOString()
      .slice(0, 16)
      .replace("T", " ");

    const res = await fetch(`/api/dems/projects/${projectId}/note`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: `[${timestamp}] ‚Äî ${text}` }),
    });

    const data = await res.json();

    replaceProject(data.project);
    renderAll();
  } catch (err) {
    alert("Error adding note");
  }
}

async function editNote(projectId, index, oldText) {
  const text = prompt("Edit note:", oldText);
  if (!text) return;

  try {
    const res = await fetch(`/api/dems/projects/${projectId}/note/edit`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ index, text }),
    });

    const data = await res.json();
    replaceProject(data.project);
    renderAll();
  } catch (err) {
    alert("Error editing note");
  }
}

async function deleteNote(projectId, index) {
  if (!confirm("Delete note?")) return;

  try {
    const res = await fetch(`/api/dems/projects/${projectId}/note/delete`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ index }),
    });

    const data = await res.json();
    replaceProject(data.project);
    renderAll();
  } catch (err) {
    alert("Error deleting note");
  }
}

/* ========================
   ARCHIVE / DELETE PROJECT
======================== */

async function toggleArchive(id, archived) {
  const url = archived
    ? `/api/dems/projects/${id}/restore`
    : `/api/dems/projects/${id}/archive`;

  const res = await fetch(url, { method: "POST" });
  const data = await res.json();

  replaceProject(data.project);
  renderAll();
}

async function deleteProject(id) {
  if (!confirm("Delete project permanently?")) return;

  const res = await fetch(`/api/dems/projects/${id}/delete`, {
    method: "POST",
  });

  const data = await res.json();

  activeProjects = activeProjects.filter((p) => p.id !== id);
  archivedProjects = archivedProjects.filter((p) => p.id !== id);

  renderAll();
}

/* ========================
        HELPERS
======================== */

function replaceProject(updated) {
  activeProjects = activeProjects.map((p) =>
    p.id === updated.id ? updated : p
  );
  archivedProjects = archivedProjects.map((p) =>
    p.id === updated.id ? updated : p
  );

  if (updated.archived) {
    activeProjects = activeProjects.filter((p) => p.id !== updated.id);
    if (!archivedProjects.find((p) => p.id === updated.id)) {
      archivedProjects.push(updated);
    }
  } else {
    archivedProjects = archivedProjects.filter((p) => p.id !== updated.id);
    if (!activeProjects.find((p) => p.id === updated.id)) {
      activeProjects.push(updated);
    }
  }
}

/* ========================
    LOAD PROJECTS
======================== */

async function loadProjects() {
  try {
    const resA = await fetch("/api/dems/projects?archived=false");
    const dataA = await resA.json();
    activeProjects = dataA.projects || [];

    const resB = await fetch("/api/dems/projects?archived=true");
    const dataB = await resB.json();
    archivedProjects = dataB.projects || [];

    renderAll();
  } catch (err) {
    projectsContainer.innerHTML = "Error loading projects";
  }
}

function renderAll() {
  const list = filterBySearch(getCurrentList());
  buildChips(list);
  renderProjects(list);

  const slaCount = activeProjects.filter((p) => p.sla_breached).length;
  notif.textContent =
    slaCount > 0
      ? `‚óè ${slaCount} DEM(s) with SLA breach`
      : "‚óè All active DEMs within SLA window";
}

/* ========================
     CYBERPUNK TRAIL
======================== */

document.addEventListener("mousemove", (e) => {
  const g = document.createElement("div");
  g.classList.add("ghost");
  g.style.left = e.pageX + "px";
  g.style.top = e.pageY + "px";
  document.body.appendChild(g);
  setTimeout(() => g.remove(), 600);
});

/* ========================
      START APP
======================== */

loadProjects();
</script>

</body>
</html>


