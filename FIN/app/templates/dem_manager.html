<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Manager</title>
  <link rel="stylesheet" href="/static/style.css" />

  <!-- Estilos extra para notas, modales y Portfolio Report -->
  <style>
    /* Animaci√≥n pop neon para modales */
    .modal .modal-content.neon-pop {
      animation: neonPop 0.35s ease-out;
    }

    @keyframes neonPop {
      0%   { transform: scale(0.85); opacity: 0; box-shadow: 0 0 0 rgba(255,51,102,0); }
      60%  { transform: scale(1.03); opacity: 1; box-shadow: 0 0 24px rgba(255,51,102,0.65); }
      100% { transform: scale(1);    opacity: 1; box-shadow: 0 0 12px rgba(255,51,102,0.45); }
    }

    /* Icono de notas recientes en el t√≠tulo de la tarjeta */
    .dem-note-dot {
      display: inline-flex;
      width: 10px;
      height: 10px;
      margin-left: 6px;
      border-radius: 999px;
      background: radial-gradient(circle, #ff5c9f 0%, #ff003c 45%, transparent 70%);
      box-shadow: 0 0 10px rgba(255, 0, 80, 0.9);
      animation: pulseGlow 1.4s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%   { transform: scale(0.9); box-shadow: 0 0 6px rgba(255, 0, 80, 0.7); }
      50%  { transform: scale(1.2); box-shadow: 0 0 18px rgba(255, 0, 80, 1); }
      100% { transform: scale(0.9); box-shadow: 0 0 6px rgba(255, 0, 80, 0.7); }
    }

    /* Caja superior de timeline de notas con botones Edit/Delete */
    .notes-timeline-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: linear-gradient(90deg, rgba(25,10,35,0.95), rgba(60,10,70,0.95));
      border: 1px solid rgba(255, 120, 200, 0.35);
      font-size: 0.8rem;
    }

    .notes-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #ff8fb8;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .notes-timeline-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 150px;
      overflow-y: auto;
    }

    .note-item {
      padding: 3px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.12);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .note-item:last-child {
      border-bottom: none;
    }

    .note-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .edit-note-btn,
    .delete-note-btn {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.25);
      padding: 2px 6px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.7rem;
      transition: 0.15s ease-out;
    }

    .edit-note-btn:hover {
      background: #00ffe7;
      color: #000;
      box-shadow: 0 0 10px #00fff0;
    }

    .delete-note-btn {
      background: rgba(255,0,80,0.25);
    }

    .delete-note-btn:hover {
      background: #ff003c;
      color: #fff;
      box-shadow: 0 0 10px #ff003c;
    }

    /* Panel de notas inferior (lista simple) */
    .dem-notes-panel {
      margin-top: 4px;
      padding: 6px 10px;
      border-radius: 10px;
      background: linear-gradient(90deg, rgba(15, 15, 25, 0.9), rgba(40, 10, 50, 0.9));
      border: 1px solid rgba(255, 255, 255, 0.06);
      max-height: 140px;
      overflow-y: auto;
      font-size: 0.78rem;
    }

    .dem-notes-panel h4 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #ff8fb8;
      margin: 0 0 4px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dem-notes-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .dem-notes-list li {
      padding: 3px 0;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
      line-height: 1.3;
    }

    .dem-note-empty {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
      font-style: italic;
    }

    /* Caja del Portfolio Report con scroll independiente */
    #dem-report-output {
      max-height: 420px;
      overflow-y: auto;
      overflow-x: auto;
      padding: 18px;
      background: rgba(5, 10, 25, 0.75);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      white-space: pre-wrap;
      font-family: "Consolas","Courier New",monospace;
      line-height: 1.35;
      font-size: 0.95rem;
      color: rgba(255,255,255,0.92);
      scrollbar-width: thin;
      scrollbar-color: #00f0ff #081018;
    }
  </style>
</head>

<body>
<!-- MODAL: New / Edit Project (correctamente DENTRO del body) -->
<div id="project-modal" class="modal hidden">
  <div class="modal-content">
    <h2 id="modal-title">New Project</h2>

    <form id="project-form">
      <div class="form-grid">
        <label>Project Name
          <input type="text" name="name" required />
        </label>

        <label>Sponsor
          <input type="text" name="sponsor" />
        </label>

        <label>Requester
          <input type="text" name="requester" />
        </label>

        <label>BA Owner
          <input type="text" name="ba_owner" />
        </label>

        <label>Project Title
          <input type="text" name="title" />
        </label>

        <label>Change Requested
          <input type="text" name="change_request" />
        </label>

        <label>Cost Center
          <input type="text" name="cost_center" />
        </label>

        <label>Status
          <select name="status">
            <option>Specific Requirements</option>
            <option>Business Case Creation</option>
            <option>Review/Cost Estimation</option>
            <option>Regional Business Center</option>
            <option>Business Operations Approval</option>
            <option>Functional Design</option>
            <option>SOW Request</option>
            <option>Budget Approval</option>
            <option>CLM Request</option>
            <option>Create CSR/PO</option>
            <option>Change Request in Progress</option>
            <option>Cancel</option>
            <option>Closed</option>
          </select>
        </label>

        <label>Workflow Status
          <select name="workflow_status">
            <option>Pending Est. Approval</option>
            <option>Pending SOW</option>
            <option>Pending CCB Review</option>
            <option>CLM Process</option>
            <option>Development</option>
            <option>Development Queue</option>
            <option>IT Testing</option>
            <option>Dev Business Testing</option>
            <option>Migration UAT</option>
            <option>Migration PROD</option>
            <option>IT Review</option>
            <option>IT MGR Approval</option>
            <option>Rejected</option>
            <option>Closed</option>
            <option>In Production</option>
          </select>
        </label>

        <label>Current Task Owner
          <input type="text" name="current_owner" />
        </label>

        <label>Start Date
          <input type="date" name="start_date" />
        </label>
      </div>

      <div class="modal-actions">
        <button type="button" id="cancel-modal">Cancel</button>
        <button type="submit" id="save-project">Save</button>
      </div>
    </form>
  </div>
</div>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h1>Project Manager</h1>
    <button type="button" onclick="window.location.href='/'">‚Üê Back to Chat</button>

    <div class="section">
      <p class="hint">
        Gestiona todos tus DEM / proyectos con contexto, notas, SLA y documentos en un solo lugar.
      </p>
    </div>

    <div class="section small">
      <div class="quotes">
        <p>‚ÄúProjects gain power when they stay visible.‚Äù</p>
        <p>‚ÄúClarity, ownership and follow-up keep change alive.‚Äù</p>
      </div>
    </div>
  </aside>

  <div class="holo-arrow"></div>

  <!-- Main content -->
  <main class="chat">
    <header class="chat-header">
      <div>
        <strong>Project Manager Portfolio</strong>
        <span id="dems-notifications" class="status-dot">‚óè Monitoring</span>
      </div>
    </header>

    <div class="dems-layout">
      <!-- Toolbar -->
      <div class="dems-toolbar">
        <div class="dems-toolbar-top">
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="create-project-btn" type="button" class="btn-cyber">‚ú¶ New Project</button>

            <div class="dems-tabs">
              <button type="button" class="dems-tab active" data-tab="active">Active DEMs</button>
              <button type="button" class="dems-tab" data-tab="archived">Archived DEMs</button>
            </div>
          </div>

          <div class="dems-download-group">
            <button id="generate-report-btn" type="button">üìÑ Generate Portfolio Report</button>
            <button id="download-txt-btn" type="button">‚¨á TXT</button>
            <button id="download-docx-btn" type="button">‚¨á DOCX</button>
            <button id="download-pdf-btn" type="button">‚¨á PDF</button>
          </div>
        </div>

        <div class="dems-search-row">
          <input id="dems-search" type="text" placeholder="Search DEMs by name, owner, status, notes, etc..." />
        </div>

        <div id="dem-chip-bar" class="dem-chip-bar"></div>
      </div>

      <!-- Projects -->
      <section class="dems-projects-section">
        <h2>Projects</h2>
        <div id="dems-projects" class="dems-projects"></div>
      </section>

      <!-- Portfolio Report -->
      <section class="dems-report-section">
        <h2>Portfolio Report</h2>
        <div id="dem-report-output">
          Click "Generate Portfolio Report" to build a fresh executive summary.
        </div>
      </section>
    </div>
  </main>
</div>

<!-- Part√≠culas decorativas -->
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>

<script>
  const createProjectBtn = document.getElementById('create-project-btn');
  const generateReportBtn = document.getElementById('generate-report-btn');
  const downloadTxtBtn = document.getElementById('download-txt-btn');
  const downloadDocxBtn = document.getElementById('download-docx-btn');
  const downloadPdfBtn = document.getElementById('download-pdf-btn');
  const projectsContainer = document.getElementById('dems-projects');
  const notif = document.getElementById('dems-notifications');
  const reportOutput = document.getElementById('dem-report-output');
  const searchInput = document.getElementById('dems-search');
  const chipBar = document.getElementById('dem-chip-bar');
  const tabs = document.querySelectorAll('.dems-tab');

  let activeProjects = [];
  let archivedProjects = [];
  let currentTab = 'active';
  let searchText = '';

  /* ========= MODAL PROJECT FORM ========= */
  function openProjectForm(existing) {
    const modal = document.getElementById("project-modal");
    const form = document.getElementById("project-form");
    const title = document.getElementById("modal-title");

    modal.classList.remove("hidden");

    const content = modal.querySelector(".modal-content");
    if (content) {
      content.classList.add("neon-pop");
      content.addEventListener("animationend", () => {
        content.classList.remove("neon-pop");
      }, { once: true });
    }

    form.reset();
    if (existing) {
      title.textContent = "Edit Project";
      for (const k in existing) {
        if (form[k]) form[k].value = existing[k];
      }
    } else {
      title.textContent = "New Project";
    }

    return new Promise(resolve => {
      form.onsubmit = e => {
        e.preventDefault();
        modal.classList.add("hidden");
        const data = Object.fromEntries(new FormData(form));
        resolve(data);
      };

      document.getElementById("cancel-modal").onclick = () => {
        modal.classList.add("hidden");
        resolve(null);
      };
    });
  }

  /* ========= CREATE PROJECT ========= */
  createProjectBtn.addEventListener('click', async () => {
    const payload = await openProjectForm(null);
    if (!payload) return;

    try {
      const res = await fetch('/api/dems/projects', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.project) {
        activeProjects.push(data.project);
        renderAll();
      } else {
        alert('Error creating project: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error creating DEM: ' + err);
    }
  });

  /* ========= REPORT (PORTFOLIO) ========= */
  generateReportBtn.addEventListener('click', async () => {
    reportOutput.textContent = 'Generating report...';
    try {
      const res = await fetch('/api/dems/report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
      });
      const data = await res.json();
      if (data.report) {
        reportOutput.textContent = data.report;
      } else {
        reportOutput.textContent = 'Error generating report: ' + (data.error || 'Unknown error');
      }
    } catch (err) {
      reportOutput.textContent = 'Connection error generating report: ' + err;
    }
  });

  async function downloadReport(format) {
    try {
      const res = await fetch('/api/dems/download/' + format);
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        alert('Error downloading report: ' + (data.error || res.statusText));
        return;
      }
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'dems_portfolio.' + format;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      alert('Connection error downloading report: ' + err);
    }
  }

  downloadTxtBtn.addEventListener('click', () => downloadReport('txt'));
  downloadDocxBtn.addEventListener('click', () => downloadReport('docx'));
  downloadPdfBtn.addEventListener('click', () => downloadReport('pdf'));

  /* ========= TABS ========= */
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentTab = tab.dataset.tab;
      renderAll();
    });
  });

  /* ========= SEARCH ========= */
  searchInput.addEventListener('input', () => {
    searchText = searchInput.value.toLowerCase();
    renderAll();
  });

  function getCurrentList() {
    return currentTab === 'active' ? activeProjects : archivedProjects;
  }

  function filterBySearch(list) {
    if (!searchText) return list;
    return list.filter(p => {
      const notesText = (p.notes || []).map(n => {
        if (typeof n === 'string') return n;
        if (n && typeof n === 'object') return `[${n.date || ''}] ${n.text || ''}`;
        return '';
      }).join(' ');

      const fields = [
        p.name,
        p.title,
        p.sponsor,
        p.requester,
        p.ba_owner,
        p.cost_center,
        p.status,
        p.workflow_status,
        p.current_owner,
        p.last_note,
        notesText
      ].join(' ').toLowerCase();

      return fields.includes(searchText);
    });
  }

  function buildChips(list) {
    chipBar.innerHTML = '';
    if (!list.length) return;
    list.forEach(p => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'dem-chip';
      chip.textContent = p.name || '(No name)';
      chip.addEventListener('click', () => {
        const card = document.querySelector('.dem-card[data-id="' + p.id + '"]');
        if (card) {
          document.querySelectorAll('.dem-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
      chipBar.appendChild(chip);
    });
  }

  function renderAll() {
    const list = filterBySearch(getCurrentList());
    buildChips(list);
    renderProjects(list);
    updateNotif();
  }

  /* ========= RENDER PROJECT CARDS ========= */
  function renderProjects(list) {
    projectsContainer.innerHTML = '';
    if (!list.length) {
      projectsContainer.innerHTML = "<p class='hint'>No projects in this view.</p>";
      return;
    }

    list.forEach(p => {
      const card = document.createElement('article');
      card.className = 'dem-card';
      card.dataset.id = p.id;
      if (p.sla_breached) card.classList.add('sla-breached');
      if (p.archived) card.classList.add('archived');

      const header = document.createElement('div');
      header.className = 'dem-card-header';
      header.innerHTML = `
        <div>
          <h3>${p.name || '(No name)'}</h3>
          <p class="dem-subtitle">
            ${p.title || ''}
            ${p.last_note ? '<span class="dem-note-dot" title="Recent updates"></span>' : ''}
          </p>
        </div>
        <div class="dem-tags">
          <span class="dem-tag primary">${p.status || 'N/A'}</span>
          <span class="dem-tag">${p.workflow_status || ''}</span>
          <span class="dem-tag ${p.sla_breached ? 'sla-breached' : 'sla-ok'}">
            ${p.sla_breached ? 'SLA Breached' : 'SLA OK'}
          </span>
        </div>
      `;
      card.appendChild(header);

      const meta = document.createElement('div');
      meta.className = 'dem-meta';
      meta.innerHTML = `
        <p><strong>Sponsor:</strong> ${p.sponsor || '-'}</p>
        <p><strong>Requester:</strong> ${p.requester || '-'}</p>
        <p><strong>BA Owner:</strong> ${p.ba_owner || '-'}</p>
        <p><strong>Current Task Owner:</strong> ${p.current_owner || '-'}</p>
        <p><strong>Cost Center:</strong> ${p.cost_center || '-'}</p>
        <p><strong>Start Date:</strong> ${p.start_date || '-'}</p>
        <p><strong>Duration (days):</strong> ${p.duration_days ?? '-'}</p>
      `;
      card.appendChild(meta);

      const lastNote = document.createElement('div');
      lastNote.className = 'dem-last-note';
      lastNote.innerHTML = `
        <strong>Last Note:</strong>
        <p>${p.last_note || 'No notes yet.'}</p>
      `;
      card.appendChild(lastNote);

      /* ----- NOTES TIMELINE SUPERIOR (EDIT / DELETE) ----- */
      if (p.notes && p.notes.length > 0) {
        const notesBox = document.createElement("div");
        notesBox.className = "notes-timeline-box";

        notesBox.innerHTML = `
          <div class="notes-title">
            <span>‚ú¶</span> Notes Timeline (Newest First)
          </div>
        `;

        const ulTop = document.createElement("ul");
        ulTop.className = "notes-timeline-list";

        const notesArray = p.notes || [];

        notesArray
          .map((n, i) => ({ data: n, index: i }))
          .reverse()
          .forEach(note => {
            const li = document.createElement("li");
            li.className = "note-item";

            let textLine = "";
            if (typeof note.data === "string") {
              textLine = note.data;
            } else if (note.data && typeof note.data === "object") {
              textLine = `[${note.data.date || ''}] ‚Äî ${note.data.text || ''}`;
            }

            li.innerHTML = `
              <span>${textLine}</span>
              <div class="note-actions">
                <button type="button" class="edit-note-btn" title="Edit note">‚úé</button>
                <button type="button" class="delete-note-btn" title="Delete note">üóë</button>
              </div>
            `;

            li.querySelector(".edit-note-btn").addEventListener("click", () => {
              editNote(p.id, note.index, textLine);
            });

            li.querySelector(".delete-note-btn").addEventListener("click", () => {
              deleteNote(p.id, note.index);
            });

            ulTop.appendChild(li);
          });

        notesBox.appendChild(ulTop);
        card.appendChild(notesBox);
      }

      /* ----- PANEL INFERIOR SIMPLE DE NOTAS ----- */
      const notesPanel = document.createElement('div');
      notesPanel.className = 'dem-notes-panel';

      const notesHeader = document.createElement('h4');
      notesHeader.innerHTML = '<span class="icon">‚ú¶</span> Notes timeline (newest first)';
      notesPanel.appendChild(notesHeader);

      if (p.notes && p.notes.length) {
        const ul = document.createElement('ul');
        ul.className = 'dem-notes-list';
        [...p.notes].slice().reverse().forEach(n => {
          const li = document.createElement('li');
          if (typeof n === 'string') {
            li.textContent = n;
          } else if (n && typeof n === 'object') {
            li.textContent = `[${n.date || ''}] ‚Äî ${n.text || ''}`;
          } else {
            li.textContent = String(n);
          }
          ul.appendChild(li);
        });
        notesPanel.appendChild(ul);
      } else {
        const empty = document.createElement('div');
        empty.className = 'dem-note-empty';
        empty.textContent = 'No notes registered for this DEM yet.';
        notesPanel.appendChild(empty);
      }

      card.appendChild(notesPanel);

      const banner = document.createElement('div');
      banner.className = 'dem-sla-banner ' + (p.sla_breached ? 'breached' : 'ok');
      banner.textContent = p.sla_breached
        ? 'SLA Breached ‚Äì please review this DEM as soon as possible.'
        : 'SLA OK ‚Äì project updated recently.';
      card.appendChild(banner);

      /* ----- ACTION BUTTONS (CON IA RESTAURADA) ----- */
      const actions = document.createElement('div');
      actions.className = 'dem-actions';

      // Add Note
      const addNoteBtn = document.createElement('button');
      addNoteBtn.type = 'button';
      addNoteBtn.textContent = 'Add Note';
      addNoteBtn.addEventListener('click', () => addNote(p.id));

      // File upload para IA
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.doc,.docx,.pdf,.txt';
      fileInput.style.display = 'none';
      fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files.length) {
          uploadDoc(p.id, fileInput.files[0]);
        }
      });

      const attachBtn = document.createElement('button');
      attachBtn.type = 'button';
      attachBtn.textContent = 'Attach Doc & Analyze';
      attachBtn.addEventListener('click', () => fileInput.click());

      // Ver resumen
      const viewSummaryBtn = document.createElement('button');
      viewSummaryBtn.type = 'button';
      viewSummaryBtn.textContent = 'View Document Summary';
      viewSummaryBtn.addEventListener('click', () => {
        if (p.doc_summary) {
          alert(p.doc_summary);
        } else {
          alert('No document summary stored for this DEM yet.');
        }
      });

      // Edit project
      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.textContent = 'Edit Project';
      editBtn.addEventListener('click', () => editProject(p.id));

      // Archive / Restore
      const archiveBtn = document.createElement('button');
      archiveBtn.type = 'button';
      archiveBtn.textContent = p.archived ? 'Restore' : 'Archive';
      archiveBtn.classList.add('archive');
      archiveBtn.addEventListener('click', () => toggleArchive(p.id, !!p.archived));

      // Delete
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'Delete';
      deleteBtn.classList.add('danger');
      deleteBtn.addEventListener('click', () => deleteProject(p.id));

      actions.appendChild(addNoteBtn);
      actions.appendChild(attachBtn);
      actions.appendChild(viewSummaryBtn);
      actions.appendChild(editBtn);
      actions.appendChild(archiveBtn);
      actions.appendChild(deleteBtn);
      actions.appendChild(fileInput);

      card.appendChild(actions);
      projectsContainer.appendChild(card);
    });
  }

  function updateNotif() {
    const totalActiveSla = activeProjects.filter(p => p.sla_breached).length;
    if (totalActiveSla > 0) {
      notif.textContent = `‚óè ${totalActiveSla} DEM(s) with SLA breached`;
    } else {
      notif.textContent = '‚óè All active DEMs within SLA window';
    }
  }

  /* ========= NOTES HANDLERS ========= */
  async function addNote(projectId) {
    const text = prompt("Enter your update note:");
    if (!text) return;

    const timestamp = new Date().toISOString().slice(0,16).replace("T"," ");
    const notePayload = `[${timestamp}] ‚Äî ${text}`;

    try {
      const res = await fetch(`/api/dems/projects/${projectId}/note`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text: notePayload })
      });

      const data = await res.json();

      if (data.project) {
        replaceProject(data.project);
        renderAll();
      } else {
        alert("Error saving note: " + (data.error || "Unknown"));
      }
    } catch (err) {
      alert("Connection error saving note: " + err);
    }
  }

  async function editNote(projectId, noteIndex, oldText) {
    const newText = prompt("Edit note:", oldText);
    if (!newText || newText.trim() === oldText.trim()) return;

    try {
      const res = await fetch(`/api/dems/projects/${projectId}/note/edit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ index: noteIndex, text: newText })
      });

      const data = await res.json();

      if (data.project) {
        replaceProject(data.project);
        renderAll();
      } else {
        alert("Error editing note: " + (data.error || "Unknown"));
      }
    } catch (err) {
      alert("Connection error editing note: " + err);
    }
  }

  async function deleteNote(projectId, noteIndex) {
    if (!confirm("Delete this note?")) return;

    try {
      const res = await fetch(`/api/dems/projects/${projectId}/note/delete`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ index: noteIndex })
      });

      const data = await res.json();

      if (data.project) {
        replaceProject(data.project);
        renderAll();
      } else {
        alert("Error deleting note: " + (data.error || "Unknown"));
      }
    } catch (err) {
      alert("Connection error deleting note: " + err);
    }
  }

  /* ========= EDIT / ARCHIVE / DELETE PROJECT ========= */
  async function editProject(projectId) {
    const project = [...activeProjects, ...archivedProjects].find(p => p.id === projectId);
    if (!project) return;
    const updated = await openProjectForm(project);
    if (!updated) return;
    try {
      const res = await fetch(`/api/dems/projects/${projectId}/update`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updated)
      });
      const data = await res.json();
      if (data.project) {
        replaceProject(data.project);
        renderAll();
      } else {
        alert('Error updating project: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error updating project: ' + err);
    }
  }

  async function uploadDoc(projectId, file) {
    const fd = new FormData();
    fd.append('file', file);

    alert('Uploading document and generating AI summary. This can take a few seconds.');

    try {
      const res = await fetch(`/api/dems/projects/${projectId}/attach`, {
        method: 'POST',
        body: fd
      });
      const data = await res.json();
      if (data.project) {
        replaceProject(data.project);
        renderAll();
        alert("Summary generated for this DEM.\n\nYou can view it with 'View Document Summary'.");
      } else {
        alert('Error attaching document: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error attaching document: ' + err);
    }
  }

  async function toggleArchive(projectId, currentlyArchived) {
    const url = currentlyArchived
      ? `/api/dems/projects/${projectId}/restore`
      : `/api/dems/projects/${projectId}/archive`;
    try {
      const res = await fetch(url, { method: 'POST' });
      const data = await res.json();
      if (data.project) {
        replaceProject(data.project);
        renderAll();
      } else {
        alert('Error updating archive status: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error updating archive status: ' + err);
    }
  }

  async function deleteProject(projectId) {
    if (!confirm('Delete this DEM permanently?')) return;
    try {
      const res = await fetch(`/api/dems/projects/${projectId}/delete`, {
        method: 'POST'
      });
      const data = await res.json();
      if (data.success) {
        activeProjects = activeProjects.filter(p => p.id !== projectId);
        archivedProjects = archivedProjects.filter(p => p.id !== projectId);
        renderAll();
      } else {
        alert('Error deleting project: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error deleting project: ' + err);
    }
  }

  function replaceProject(updated) {
    activeProjects = activeProjects.map(p => p.id === updated.id ? updated : p);
    archivedProjects = archivedProjects.map(p => p.id === updated.id ? updated : p);
    if (updated.archived) {
      activeProjects = activeProjects.filter(p => p.id !== updated.id);
      if (!archivedProjects.find(p => p.id === updated.id)) {
        archivedProjects.push(updated);
      }
    } else {
      archivedProjects = archivedProjects.filter(p => p.id !== updated.id);
      if (!activeProjects.find(p => p.id === updated.id)) {
        activeProjects.push(updated);
      }
    }
  }

  async function loadProjects() {
    try {
      const resActive = await fetch('/api/dems/projects?archived=false');
      const dataActive = await resActive.json();
      activeProjects = dataActive.projects || [];

      const resArchived = await fetch('/api/dems/projects?archived=true');
      const dataArchived = await resArchived.json();
      archivedProjects = dataArchived.projects || [];

      renderAll();
    } catch (err) {
      projectsContainer.innerHTML = "<p class='hint'>Error loading DEM list: " + err + "</p>";
    }
  }

  /* Trazo de ghost cyberpunk */
  document.addEventListener('mousemove', (e) => {
    const g = document.createElement('div');
    g.classList.add('ghost');
    g.style.left = e.pageX + 'px';
    g.style.top = e.pageY + 'px';
    document.body.appendChild(g);
    setTimeout(() => g.remove(), 600);
  });

  loadProjects();
</script>
</body>
</html>
