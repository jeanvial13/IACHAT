<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Manager</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>

<!-- MODAL: New / Edit Project -->
<div id="project-modal" class="modal hidden">
  <div class="modal-content">
    <h2 id="modal-title">New Project</h2>

    <form id="project-form">
      <div class="form-grid">

        <label>Project Name
          <input type="text" name="name" required />
        </label>

        <label>Sponsor
          <input type="text" name="sponsor" />
        </label>

        <label>Requester
          <input type="text" name="requester" />
        </label>

        <label>BA Owner
          <input type="text" name="ba_owner" />
        </label>

        <label>Project Title
          <input type="text" name="title" />
        </label>

        <label>Change Requested
          <input type="text" name="change_request" />
        </label>

        <label>Cost Center
          <input type="text" name="cost_center" />
        </label>

        <label>Status
          <select name="status">
            <option>Specific Requirements</option>
            <option>Business Case Creation</option>
            <option>Review/Cost Estimation</option>
            <option>Regional Business Center</option>
            <option>Business Operations Approval</option>
            <option>Functional Design</option>
            <option>SOW Request</option>
            <option>Budget Approval</option>
            <option>CLM Request</option>
            <option>Create CSR/PO</option>
            <option>Change Request in Progress</option>
            <option>Cancel</option>
            <option>Closed</option>
          </select>
        </label>

        <label>Workflow Status
          <select name="workflow_status">
            <option>Pending Est. Approval</option>
            <option>Pending SOW</option>
            <option>Pending CCB Review</option>
            <option>CLM Process</option>
            <option>Development</option>
            <option>Development Queue</option>
            <option>IT Testing</option>
            <option>Dev Business Testing</option>
            <option>Migration UAT</option>
            <option>Migration PROD</option>
            <option>IT Review</option>
            <option>IT MGR Approval</option>
            <option>Rejected</option>
            <option>Closed</option>
            <option>In Production</option>
          </select>
        </label>

        <label>Current Task Owner
          <input type="text" name="current_owner" />
        </label>

        <label>Start Date
          <input type="date" name="start_date" />
        </label>

      </div>

      <div class="modal-actions">
        <button type="button" id="cancel-modal">Cancel</button>
        <button type="submit" id="save-project">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Notes Manager -->
<div id="notes-modal" class="modal hidden">
  <div class="modal-content notes-modal">
    <div class="notes-modal-header">
      <h2>Notes for DEM: <span id="notes-modal-title"></span></h2>
      <button id="notes-modal-close" type="button" class="icon-button">‚úï</button>
    </div>
    <div id="notes-modal-body" class="notes-modal-body">
      <!-- Notes list rendered by JS -->
    </div>
    <div class="notes-modal-footer">
      <button id="notes-modal-add" type="button" class="btn-cyber">+ Add Note</button>
    </div>
  </div>
</div>

<body>
<div class="app">
  <aside class="sidebar">
    <h1>Project Manager</h1>
    <button type="button" onclick="window.location.href='/'">‚Üê Back to Chat</button>

    <div class="section">
      <p class="hint">
        Gestiona todos tus DEM / proyectos con contexto, notas, SLA y documentos en un solo lugar.
      </p>
    </div>

    <div class="section small">
      <div class="quotes">
        <p>‚ÄúProjects gain power when they stay visible.‚Äù</p>
        <p>‚ÄúClarity, ownership and follow-up keep change alive.‚Äù</p>
      </div>
    </div>
  </aside>

  <div class="holo-arrow"></div>

  <main class="chat">
    <header class="chat-header">
      <div>
        <strong>Project Manager Portfolio</strong>
        <span id="dems-notifications" class="status-dot">‚óè Monitoring</span>
      </div>
    </header>

    <div class="dems-layout">
      <div class="dems-toolbar">
        <div class="dems-toolbar-top">
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="create-project-btn" type="button" class="btn-cyber">‚ú¶ New Project</button>
            <div class="dems-tabs">
              <button type="button" class="dems-tab active" data-tab="active">Active DEMs</button>
              <button type="button" class="dems-tab" data-tab="archived">Archived DEMs</button>
            </div>
          </div>
          <div class="dems-download-group">
            <button id="generate-report-btn" type="button">üìÑ Generate Portfolio Report</button>
            <button id="download-txt-btn" type="button">‚¨á TXT</button>
            <button id="download-docx-btn" type="button">‚¨á DOCX</button>
            <button id="download-pdf-btn" type="button">‚¨á PDF</button>
          </div>
        </div>

        <div class="dems-search-row">
          <input id="dems-search" type="text" placeholder="Search DEMs by name, owner, status, notes, etc..." />
        </div>

        <div id="dem-chip-bar" class="dem-chip-bar"></div>
      </div>

      <section class="dems-projects-section">
        <h2>Projects</h2>
        <div id="dems-projects" class="dems-projects"></div>
      </section>

      <section class="dems-report-section">
        <h2>Portfolio Report</h2>
        <div id="dem-report-output">Click "Generate Portfolio Report" to build a fresh executive summary.</div>
      </section>
    </div>
  </main>
</div>

<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>

<script>
  const createProjectBtn = document.getElementById('create-project-btn');
  const generateReportBtn = document.getElementById('generate-report-btn');
  const downloadTxtBtn = document.getElementById('download-txt-btn');
  const downloadDocxBtn = document.getElementById('download-docx-btn');
  const downloadPdfBtn = document.getElementById('download-pdf-btn');
  const projectsContainer = document.getElementById('dems-projects');
  const notif = document.getElementById('dems-notifications');
  const reportOutput = document.getElementById('dem-report-output');
  const searchInput = document.getElementById('dems-search');
  const chipBar = document.getElementById('dem-chip-bar');
  const tabs = document.querySelectorAll('.dems-tab');

  // Notes modal elements
  const notesModal = document.getElementById('notes-modal');
  const notesModalTitle = document.getElementById('notes-modal-title');
  const notesModalBody = document.getElementById('notes-modal-body');
  const notesModalClose = document.getElementById('notes-modal-close');
  const notesModalAdd = document.getElementById('notes-modal-add');

  let activeProjects = [];
  let archivedProjects = [];
  let currentTab = 'active';
  let searchText = '';
  let currentNotesProjectId = null;

  // ---------- Helpers ----------

  function allProjects() {
    return [...activeProjects, ...archivedProjects];
  }

  function findProjectById(id) {
    return allProjects().find(p => p.id === id);
  }

  function safeHtml(text) {
    if (!text) return '';
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function formatNotePreview(note) {
    if (!note) return 'No notes yet.';
    if (typeof note === 'string') return note;
    const date = note.date || '';
    const text = note.text || '';
    return date ? `[${date}] ‚Äî ${text}` : text;
  }

  // ---------- Modal Project Form ----------

  function openProjectForm(existing) {
    const modal = document.getElementById("project-modal");
    const form = document.getElementById("project-form");
    const title = document.getElementById("modal-title");

    modal.classList.remove("hidden");

    form.reset();
    if (existing) {
      title.textContent = "Edit Project";
      for (const k in existing) {
        if (form[k]) form[k].value = existing[k];
      }
    } else {
      title.textContent = "New Project";
    }

    return new Promise(resolve => {
      form.onsubmit = e => {
        e.preventDefault();
        modal.classList.add("hidden");
        const data = Object.fromEntries(new FormData(form));
        resolve(data);
      };

      document.getElementById("cancel-modal").onclick = () => {
        modal.classList.add("hidden");
        resolve(null);
      };
    });
  }

  // ---------- Create Project ----------

  createProjectBtn.addEventListener('click', async () => {
    const payload = await openProjectForm(null);
    if (!payload) return;
    try {
      const res = await fetch('/api/dems/projects', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.project) {
        activeProjects.push(data.project);
        renderAll();
      } else {
        alert('Error creating project: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error creating DEM: ' + err);
    }
  });

  // ---------- Portfolio Report ----------

  generateReportBtn.addEventListener('click', async () => {
    reportOutput.textContent = 'Generating report...';
    try {
      const res = await fetch('/api/dems/report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
      });
      const data = await res.json();
      if (data.report) {
        reportOutput.textContent = data.report;
      } else {
        reportOutput.textContent = 'Error generating report: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      reportOutput.textContent = 'Connection error generating report: ' + err;
    }
  });

  async function downloadReport(format) {
    try {
      const res = await fetch('/api/dems/download/' + format);
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        alert('Error downloading report: ' + (data.error || res.statusText));
        return;
      }
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'dems_portfolio.' + format;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      alert('Connection error downloading report: ' + err);
    }
  }

  downloadTxtBtn.addEventListener('click', () => downloadReport('txt'));
  downloadDocxBtn.addEventListener('click', () => downloadReport('docx'));
  downloadPdfBtn.addEventListener('click', () => downloadReport('pdf'));

  // ---------- Tabs ----------

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentTab = tab.dataset.tab;
      renderAll();
    });
  });

  // ---------- Search ----------

  searchInput.addEventListener('input', () => {
    searchText = searchInput.value.toLowerCase();
    renderAll();
  });

  function getCurrentList() {
    return currentTab === 'active' ? activeProjects : archivedProjects;
  }

  function filterBySearch(list) {
    if (!searchText) return list;
    return list.filter(p => {
      const notesText = (p.notes || [])
        .map(n => typeof n === 'string' ? n : (n.text || ''))
        .join(' ');
      const fields = [
        p.name,
        p.title,
        p.sponsor,
        p.requester,
        p.ba_owner,
        p.cost_center,
        p.status,
        p.workflow_status,
        p.current_owner,
        p.last_note && typeof p.last_note === 'string'
          ? p.last_note
          : '',
        notesText
      ].join(' ').toLowerCase();
      return fields.includes(searchText);
    });
  }

  function buildChips(list) {
    chipBar.innerHTML = '';
    if (!list.length) return;
    list.forEach(p => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'dem-chip';
      chip.textContent = p.name || '(No name)';
      chip.dataset.id = p.id;
      chip.addEventListener('click', () => {
        const card = document.querySelector('.dem-card[data-id="' + p.id + '"]');
        if (card) {
          document.querySelectorAll('.dem-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
      chipBar.appendChild(chip);
    });
  }

  // ---------- Rendering ----------

  function renderAll() {
    const list = filterBySearch(getCurrentList());
    buildChips(list);
    renderProjects(list);
    updateNotif();
  }

  function renderProjects(list) {
    projectsContainer.innerHTML = '';
    if (!list.length) {
      projectsContainer.innerHTML = "<p class='hint'>No projects in this view.</p>";
      return;
    }

    list.forEach(p => {
      const card = document.createElement('article');
      card.className = 'dem-card';
      card.dataset.id = p.id;
      if (p.sla_breached) card.classList.add('sla-breached');
      if (p.archived) card.classList.add('archived');

      // Header
      const header = document.createElement('div');
      header.className = 'dem-card-header';
      header.innerHTML = `
        <div>
          <h3>${safeHtml(p.name || '(No name)')}</h3>
          <p class="dem-subtitle">${safeHtml(p.title || '')}</p>
        </div>
        <div class="dem-tags">
          <span class="dem-tag primary">${safeHtml(p.status || 'N/A')}</span>
          <span class="dem-tag">${safeHtml(p.workflow_status || '')}</span>
          <span class="dem-tag ${p.sla_breached ? 'sla-breached' : 'sla-ok'}">
            ${p.sla_breached ? 'SLA Breached' : 'SLA OK'}
          </span>
        </div>
      `;
      card.appendChild(header);

      // Meta
      const meta = document.createElement('div');
      meta.className = 'dem-meta';
      meta.innerHTML = `
        <p><strong>Sponsor:</strong> ${safeHtml(p.sponsor || '-')}</p>
        <p><strong>Requester:</strong> ${safeHtml(p.requester || '-')}</p>
        <p><strong>BA Owner:</strong> ${safeHtml(p.ba_owner || '-')}</p>
        <p><strong>Current Task Owner:</strong> ${safeHtml(p.current_owner || '-')}</p>
        <p><strong>Cost Center:</strong> ${safeHtml(p.cost_center || '-')}</p>
        <p><strong>Start Date:</strong> ${safeHtml(p.start_date || '-')}</p>
        <p><strong>Duration (days):</strong> ${p.duration_days ?? '-'}</p>
      `;
      card.appendChild(meta);

      // Last note
      const lastNote = document.createElement('div');
      lastNote.className = 'dem-last-note';
      lastNote.innerHTML = `
        <strong>Last Note:</strong>
        <p>${safeHtml(formatNotePreview(p.last_note))}</p>
      `;
      card.appendChild(lastNote);

      // Notes timeline strip (opens modal)
      const notesStrip = document.createElement('div');
      notesStrip.className = 'dem-notes-strip';
      const notesCount = (p.notes || []).length || 0;
      notesStrip.innerHTML = `
        <button type="button" class="notes-open-btn">
          <span class="pulse-dot ${notesCount ? 'has-notes' : ''}"></span>
          <span class="notes-label">Notes Timeline (newest first)</span>
        </button>
        <span class="notes-meta">${notesCount} note${notesCount === 1 ? '' : 's'}</span>
      `;
      notesStrip.querySelector('.notes-open-btn').addEventListener('click', () => {
        openNotesModal(p.id);
      });
      card.appendChild(notesStrip);

      // SLA banner
      const banner = document.createElement('div');
      banner.className = 'dem-sla-banner ' + (p.sla_breached ? 'breached' : 'ok');
      banner.textContent = p.sla_breached
        ? 'SLA Breached ‚Äì please review this DEM as soon as possible.'
        : 'SLA OK ‚Äì project updated recently.';
      card.appendChild(banner);

      // Actions
      const actions = document.createElement('div');
      actions.className = 'dem-actions';

      const noteBtn = document.createElement('button');
      noteBtn.type = 'button';
      noteBtn.textContent = 'Manage Notes';
      noteBtn.addEventListener('click', () => addNote(p.id));

      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.doc,.docx,.pdf,.txt';
      fileInput.style.display = 'none';

      const uploadBtn = document.createElement('button');
      uploadBtn.type = 'button';
      uploadBtn.textContent = 'Attach Doc & Analyze';
      uploadBtn.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files.length) {
          uploadDoc(p.id, fileInput.files[0]);
        }
      });

      const insightsBtn = document.createElement('button');
      insightsBtn.type = 'button';
      insightsBtn.textContent = 'View Document Summary';
      insightsBtn.addEventListener('click', () => {
        if (p.doc_summary) {
          alert(p.doc_summary);
        } else {
          alert('No document summary stored for this DEM yet.');
        }
      });

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.textContent = 'Edit Project';
      editBtn.addEventListener('click', () => editProject(p.id));

      const archiveBtn = document.createElement('button');
      archiveBtn.type = 'button';
      archiveBtn.textContent = p.archived ? 'Restore' : 'Archive';
      archiveBtn.classList.add('archive');
      archiveBtn.addEventListener('click', () => toggleArchive(p.id, !!p.archived));

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'Delete';
      deleteBtn.classList.add('danger');
      deleteBtn.addEventListener('click', () => deleteProject(p.id));

      actions.appendChild(noteBtn);
      actions.appendChild(uploadBtn);
      actions.appendChild(insightsBtn);
      actions.appendChild(editBtn);
      actions.appendChild(archiveBtn);
      actions.appendChild(deleteBtn);
      actions.appendChild(fileInput);

      card.appendChild(actions);
      projectsContainer.appendChild(card);
    });
  }

  function updateNotif() {
    const totalActiveSla = activeProjects.filter(p => p.sla_breached).length;
    if (totalActiveSla > 0) {
      notif.textContent = `‚óè ${totalActiveSla} DEM(s) with SLA breached`;
    } else {
      notif.textContent = '‚óè All active DEMs within SLA window';
    }
  }

  // ---------- Notes Modal Logic ----------

  function closeNotesModal() {
    notesModal.classList.add('hidden');
    notesModal.classList.remove('show');
    currentNotesProjectId = null;
  }

  notesModalClose.addEventListener('click', closeNotesModal);

  notesModal.addEventListener('click', (e) => {
    if (e.target === notesModal) {
      closeNotesModal();
    }
  });

  notesModalAdd.addEventListener('click', () => {
    if (currentNotesProjectId) {
      handleAddNote(currentNotesProjectId);
    }
  });

  function openNotesModal(projectId, options = {}) {
    const project = findProjectById(projectId);
    if (!project) return;

    currentNotesProjectId = projectId;

    notesModalTitle.textContent = project.name || project.title || project.id;
    notesModalBody.innerHTML = '';

    const rawNotes = project.notes || [];
    const annotated = rawNotes.map((n, idx) =>
      typeof n === 'string'
        ? { text: n, date: '', _index: idx }
        : { text: n.text || '', date: n.date || '', _index: idx }
    );

    // Newest first: sort by date desc; fall back to index
    annotated.sort((a, b) => {
      const da = a.date ? new Date(a.date) : null;
      const db = b.date ? new Date(b.date) : null;
      if (da && db && !isNaN(da) && !isNaN(db)) {
        return db - da;
      }
      return b._index - a._index;
    });

    if (!annotated.length) {
      notesModalBody.innerHTML = '<p class="hint">No notes registered for this DEM yet.</p>';
    } else {
      const list = document.createElement('div');
      list.className = 'notes-list';

      annotated.forEach(n => {
        const row = document.createElement('div');
        row.className = 'note-row';
        row.innerHTML = `
          <div class="note-meta">
            <span class="note-dot"></span>
            <span class="note-date">${safeHtml(n.date || '')}</span>
          </div>
          <div class="note-text">${safeHtml(n.text || '')}</div>
          <div class="note-actions">
            <button type="button" class="note-edit" data-index="${n._index}">‚úè</button>
            <button type="button" class="note-delete" data-index="${n._index}">üóë</button>
          </div>
        `;
        list.appendChild(row);
      });

      notesModalBody.appendChild(list);

      notesModalBody.querySelectorAll('.note-edit').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.index, 10);
          editNote(projectId, idx);
        });
      });

      notesModalBody.querySelectorAll('.note-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.index, 10);
          deleteNote(projectId, idx);
        });
      });
    }

    notesModal.classList.remove('hidden');
    // Para animaci√≥n neon puedes usar .show en CSS
    setTimeout(() => notesModal.classList.add('show'), 10);

    if (options.autoNew) {
      setTimeout(() => handleAddNote(projectId), 200);
    }
  }

  // Bot√≥n "Manage Notes" en la tarjeta
  async function addNote(projectId) {
    openNotesModal(projectId, { autoNew: true });
  }

  async function handleAddNote(projectId) {
    const text = prompt("Enter your update note:");
    if (!text) return;

    try {
      const res = await fetch(`/api/dems/projects/${projectId}/note`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text })
      });
      const data = await res.json();
      if (data.project) {
        replaceProject(data.project);
        renderAll();
        openNotesModal(projectId);
      } else {
        alert("Error saving note: " + (data.error || "Unknown"));
      }
    } catch (err) {
      alert("Connection error saving note: " + err);
    }
  }

  async function editNote(projectId, index) {
    const project = findProjectById(projectId);
    if (!project || !project.notes || index < 0 || index >= project.notes.length) return;

    const existing = project.notes[index];
    const currentText = typeof existing === 'string'
      ? existing
      : (existing.text || '');

    const newText = prompt("Edit note:", currentText);
    if (newText === null) return; // cancel

    try {
      const res = await fetch(`/api/dems/projects/${projectId}/note/edit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ index, text: newText })
      });
      const data = await res.json();
      if (data.project) {
        replaceProject(data.project);
        renderAll();
        openNotesModal(projectId);
      } else {
        alert("Error editing note: " + (data.error || "Unknown"));
      }
    } catch (err) {
      alert("Connection error editing note: " + err);
    }
  }

  async function deleteNote(projectId, index) {
    if (!confirm("Delete this note?")) return;

    try {
      const res = await fetch(`/api/dems/projects/${projectId}/note/delete`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ index })
      });
      const data = await res.json();
      if (data.project) {
        replaceProject(data.project);
        renderAll();
        openNotesModal(projectId);
      } else {
        alert("Error deleting note: " + (data.error || "Unknown"));
      }
    } catch (err) {
      alert("Connection error deleting note: " + err);
    }
  }

  // ---------- Other DEM actions ----------

  async function editProject(projectId) {
    const project = findProjectById(projectId);
    if (!project) return;
    const updated = await openProjectForm(project);
    if (!updated) return;
    try {
      const res = await fetch(`/api/dems/projects/${projectId}/update`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updated)
      });
      const data = await res.json();
      if (data.project) {
        replaceProject(data.project);
        renderAll();
      } else {
        alert('Error updating project: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error updating project: ' + err);
    }
  }

  async function uploadDoc(projectId, file) {
    const fd = new FormData();
    fd.append('file', file);

    alert('Uploading document and generating summary. This can take a few seconds.');

    try {
      const res = await fetch(`/api/dems/projects/${projectId}/attach`, {
        method: 'POST',
        body: fd
      });
      const data = await res.json();
      if (data.project) {
        replaceProject(data.project);
        renderAll();
        alert("Summary generated for this DEM.\n\nYou can view it with 'View Document Summary'.");
      } else {
        alert('Error attaching document: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error attaching document: ' + err);
    }
  }

  async function toggleArchive(projectId, currentlyArchived) {
    const url = currentlyArchived
      ? `/api/dems/projects/${projectId}/restore`
      : `/api/dems/projects/${projectId}/archive`;
    try {
      const res = await fetch(url, { method: 'POST' });
      const data = await res.json();
      if (data.project) {
        replaceProject(data.project);
        renderAll();
      } else {
        alert('Error updating archive status: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error updating archive status: ' + err);
    }
  }

  async function deleteProject(projectId) {
    if (!confirm('Delete this DEM permanently?')) return;
    try {
      const res = await fetch(`/api/dems/projects/${projectId}/delete`, {
        method: 'POST'
      });
      const data = await res.json();
      if (data.success) {
        activeProjects = activeProjects.filter(p => p.id !== projectId);
        archivedProjects = archivedProjects.filter(p => p.id !== projectId);
        renderAll();
      } else {
        alert('Error deleting project: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Connection error deleting project: ' + err);
    }
  }

  function replaceProject(updated) {
    activeProjects = activeProjects.map(p => p.id === updated.id ? updated : p);
    archivedProjects = archivedProjects.map(p => p.id === updated.id ? updated : p);
    if (updated.archived) {
      activeProjects = activeProjects.filter(p => p.id !== updated.id);
      if (!archivedProjects.find(p => p.id === updated.id)) {
        archivedProjects.push(updated);
      }
    } else {
      archivedProjects = archivedProjects.filter(p => p.id !== updated.id);
      if (!activeProjects.find(p => p.id === updated.id)) {
        activeProjects.push(updated);
      }
    }
  }

  async function loadProjects() {
    try {
      const resActive = await fetch('/api/dems/projects?archived=false');
      const dataActive = await resActive.json();
      activeProjects = dataActive.projects || [];

      const resArchived = await fetch('/api/dems/projects?archived=true');
      const dataArchived = await resArchived.json();
      archivedProjects = dataArchived.projects || [];

      renderAll();
    } catch (err) {
      projectsContainer.innerHTML = "<p class='hint'>Error loading DEM list: " + err + "</p>";
    }
  }

  document.addEventListener('mousemove', (e) => {
    const g = document.createElement('div');
    g.classList.add('ghost');
    g.style.left = e.pageX + 'px';
    g.style.top = e.pageY + 'px';
    document.body.appendChild(g);
    setTimeout(() => g.remove(), 600);
  });

  loadProjects();
</script>
</body>
</html>
