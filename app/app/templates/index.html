<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IACHAT_PRO v3</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>

<body>
<header>IACHAT_PRO v3 :: online</header>

<div id="chat-container">
  <div id="chat-log"></div>

  <div id="chat-input-area">
    <input id="file-input" type="file" multiple />
    <textarea id="chat-input" placeholder="Escribe aquí..." rows="1"></textarea>
    <button id="send-btn">➤</button>
  </div>
</div>

<script>
const input = document.getElementById("chat-input");
const fileInput = document.getElementById("file-input");
const chatLog = document.getElementById("chat-log");
const sendBtn = document.getElementById("send-btn");

function appendMessage(sender, text) {
  const div = document.createElement("div");
  div.classList.add("msg", sender);
  div.innerHTML = `<pre>${text}</pre>`;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function typeWriter(text) {
  const msgs = chatLog.querySelectorAll(".assistant");
  const last = msgs[msgs.length - 1];
  if (!last) return;

  last.querySelector("pre").textContent = "";
  let i = 0;

  const interval = setInterval(() => {
    last.querySelector("pre").textContent += text[i] || "";
    chatLog.scrollTop = chatLog.scrollHeight;
    i++;
    if (i >= text.length) clearInterval(interval);
  }, 15);
}

async function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;

  appendMessage("user", msg);
  input.value = "";

  appendMessage("assistant", "…");

  const res = await fetch("/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: msg })
  });

  const data = await res.json();

  if (data.reply) typeWriter(data.reply);
  else appendMessage("assistant", "⚠️ Error: " + data.error);
}
</script>

</body>
</html>