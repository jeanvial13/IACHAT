<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Manager</title>
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Markdown & Highlight -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <link rel="stylesheet" href="/static/style.css" />

</head>

<body>
  <!-- MODAL: New / Edit Project -->
  <div id="project-modal" class="modal hidden">
    <div class="modal-content">
      <h2 id="modal-title">New Project</h2>

      <form id="project-form">
        <div class="form-grid">
          <label>Project Name
            <input type="text" name="name" required />
          </label>

          <label>Sponsor
            <input type="text" name="sponsor" />
          </label>

          <label>Requester
            <input type="text" name="requester" />
          </label>

          <label>BA Owner
            <input type="text" name="ba_owner" />
          </label>

          <label>Project Title
            <input type="text" name="title" />
          </label>

          <label>Change Requested
            <input type="text" name="change_request" />
          </label>

          <label>Cost Center
            <input type="text" name="cost_center" />
          </label>

          <label>Status
            <select name="status">
              <option>Idea</option>
              <option>Specific Requirements</option>
              <option>Business Case Creation</option>
              <option>Review/Cost Estimation</option>
              <option>Regional Business Center</option>
              <option>Business Operations Approval</option>
              <option>Functional Design</option>
              <option>SOW Request</option>
              <option>Budget Approval</option>
              <option>CLM Request</option>
              <option>Create CSR/PO</option>
              <option>Change Request in Progress</option>
              <option>Cancel</option>
              <option>Closed</option>
            </select>
          </label>

          <label>Workflow Status
            <select name="workflow_status">
              <option>Pending Est. Approval</option>
              <option>Pending SOW</option>
              <option>Pending CCB Review</option>
              <option>CLM Process</option>
              <option>Development</option>
              <option>Development Queue</option>
              <option>IT Testing</option>
              <option>Dev Business Testing</option>
              <option>Migration UAT</option>
              <option>Migration PROD</option>
              <option>IT Review</option>
              <option>IT MGR Approval</option>
              <option>Rejected</option>
              <option>Closed</option>
              <option>In Production</option>
            </select>
          </label>

          <label>Current Task Owner
            <input type="text" name="current_owner" />
          </label>

          <label>Start Date
            <input type="date" name="start_date" />
          </label>
          <label>Priority (1 = Critical ... 4 = Low)
            <select name="priority">
              <option value="1">1 ‚Äì Critical</option>
              <option value="2" selected>2 ‚Äì High</option>
              <option value="3">3 ‚Äì Medium</option>
              <option value="4">4 ‚Äì Low</option>
            </select>
          </label>
        </div>

        <div class="modal-actions">
          <button type="button" id="cancel-modal">Cancel</button>
          <button type="submit" id="save-project">Save</button>
        </div>
      </form>
    </div>
  </div>
  <!-- MODAL: Document Summary -->
  <div id="summary-modal" class="modal hidden">
    <div class="modal-content full-screen">
      <h2 id="summary-modal-title">Document Summary</h2>
      <div class="summary-text-box">
        <textarea id="summary-text-area" readonly></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" id="close-summary-modal" class="btn-cyber-red">Close</button>
        <button type="button" id="delete-summary-btn" class="btn-cyber danger">Delete Summary</button>
        <button type="button" id="copy-summary-btn" class="btn-cyber">Copy Summary</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Files List -->
  <div id="files-modal" class="modal hidden">
    <div class="modal-content">
      <h2 class="glitch" data-text="UPLOADED FILES">UPLOADED FILES</h2>
      <div class="files-list-container" style="overflow-y: auto; flex: 1;">
        <table class="cyber-table" id="files-table" style="width: 100%;">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Date</th>
              <th>Size</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
      <div class="modal-actions">
        <button type="button" id="close-files-modal" class="btn-cyber-red">Close</button>
      </div>
    </div>
  </div>

  <!-- MODAL: AI Analysis -->
  <div id="analysis-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 800px;">
      <h2 id="analysis-modal-title">AI Solution Analysis</h2>
      <div class="summary-text-box">
        <div id="analysis-content" class="markdown-body" style="max-height: 60vh; overflow-y: auto; padding: 10px;">
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" id="close-analysis-modal">Close</button>
        <button type="button" id="copy-analysis-btn" class="btn-cyber">Copy Analysis</button>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h1 class="glitch" data-text="PROJECT MANAGER">Project Manager</h1>
      <div class="section">
        <button type="button" class="sidebar-btn btn-cyber-clear" onclick="window.location.href='/'">
          ‚Üê Back to Chat
        </button>
      </div>

      <div class="section">
        <p class="hint">
          Manage your DEM / projects with context, notes, SLA tracking, and documents in one place.
        </p>
      </div>

      <div class="section small">
        <div class="quotes">
          <p>‚ÄúProjects gain power when they stay visible.‚Äù</p>
          <p>‚ÄúClarity, ownership and follow-up keep change alive.‚Äù</p>
        </div>
      </div>
    </aside>

    <div class="holo-arrow"></div>

    <!-- Main content -->
    <main class="chat">
      <header class="chat-header">
        <div>
          <strong>Project Manager Portfolio</strong>
          <span id="dems-notifications" class="status-dot">‚óè Monitoring</span>
        </div>
      </header>

      <div class="dems-layout">
        <!-- Toolbar -->
        <div class="dems-toolbar">
          <div class="dems-toolbar-top">
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="create-project-btn" type="button" class="btn-cyber">‚ú¶ New Project</button>

              <div class="dems-tabs">
                <button type="button" class="dems-tab active" data-tab="active">Active DEMs</button>
                <button type="button" class="dems-tab" data-tab="archived">Archived DEMs</button>
              </div>
            </div>

            <div class="dems-download-group">
              <button id="generate-report-btn" type="button" class="btn-cyber">üìÑ PORTFOLIO REPORT</button>
              <button id="generate-ai-report-btn" type="button" class="btn-cyber"
                style="border-color:var(--neon-pink); color:var(--neon-pink);">üß† AMD AI REPORT</button>
              <button id="view-files-btn" type="button" class="btn-cyber">üìÇ VIEW FILES</button>
              <button id="download-txt-btn" type="button" class="btn-cyber-red small">‚¨á TXT</button>
              <button id="download-docx-btn" type="button" class="btn-cyber-red small">‚¨á DOCX</button>
              <button id="download-pdf-btn" type="button" class="btn-cyber-red small">‚¨á PDF</button>
              <button id="export-json-btn" type="button" class="btn-cyber-red small">‚¨á Export JSON</button>
              <button id="import-json-btn" type="button" class="btn-cyber-red small">‚¨Ü Import JSON</button>
              <input id="import-json-input" type="file" accept=".json" style="display:none" />
            </div>
          </div>

          <div class="dems-search-row">
            <input id="dems-search" type="text" placeholder="Search DEMs by name, owner, status, notes, etc..." />
          </div>

          <div id="dem-chip-bar" class="dem-chip-bar"></div>
        </div>

        <!-- Snapshot Dashboard -->
        <section class="dems-dashboard-section">
          <h2>Portfolio Snapshot</h2>
          <div id="dems-dashboard" class="dems-dashboard"></div>
        </section>

        <!-- Projects -->
        <section class="dems-projects-section">
          <h2>Projects</h2>
          <div id="dems-projects" class="dems-projects"></div>
        </section>

        <!-- Portfolio Report -->
        <section id="dem-report-section" class="dems-report-section">
          <h2>Portfolio Report</h2>
          <div id="dem-report-output">
            Click "Generate Portfolio Report" to build a fresh executive summary.
          </div>
        </section>
      </div>
    </main>
    </main>
  </div>

  <!-- Cyberpunk Particles -->
  <div class="scanline"></div>
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>



  <script>
    const createProjectBtn = document.getElementById('create-project-btn');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const generateAiReportBtn = document.getElementById('generate-ai-report-btn');
    const downloadTxtBtn = document.getElementById('download-txt-btn');
    const downloadDocxBtn = document.getElementById('download-docx-btn');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');
    const projectsContainer = document.getElementById('dems-projects');
    const notif = document.getElementById('dems-notifications');
    const reportOutput = document.getElementById('dem-report-output');
    const searchInput = document.getElementById('dems-search');
    const chipBar = document.getElementById('dem-chip-bar');
    const tabs = document.querySelectorAll('.dems-tab');
    const dashboardContainer = document.getElementById('dems-dashboard');
    const exportJsonBtn = document.getElementById('export-json-btn');
    const importJsonBtn = document.getElementById('import-json-btn');
    const importJsonInput = document.getElementById('import-json-input');

    let activeProjects = [];
    let archivedProjects = [];
    let currentTab = 'active';
    let searchText = '';

    /* ========= MODAL PROJECT FORM ========= */
    function openProjectForm(existing) {
      const modal = document.getElementById("project-modal");
      const form = document.getElementById("project-form");
      const title = document.getElementById("modal-title");

      modal.classList.remove("hidden");

      const content = modal.querySelector(".modal-content");
      if (content) {
        content.classList.add("neon-pop");
        content.addEventListener("animationend", () => {
          content.classList.remove("neon-pop");
        }, { once: true });
      }

      form.reset();
      if (existing) {
        title.textContent = "Edit Project";
        for (const k in existing) {
          if (form[k]) form[k].value = existing[k];
        }
      } else {
        title.textContent = "New Project";
      }

      return new Promise(resolve => {
        form.onsubmit = e => {
          e.preventDefault();
          modal.classList.add("hidden");
          const data = Object.fromEntries(new FormData(form));
          resolve(data);
        };

        document.getElementById("cancel-modal").onclick = () => {
          modal.classList.add("hidden");
          resolve(null);
        };
      });
    }

    /* ========= MODAL SUMMARY ========= */
    function openSummaryModal(text, projectId) {
      const modal = document.getElementById("summary-modal");
      const textArea = document.getElementById("summary-text-area");
      const copyBtn = document.getElementById("copy-summary-btn");
      const closeBtn = document.getElementById("close-summary-modal");
      const deleteBtn = document.getElementById("delete-summary-btn");

      textArea.value = text;
      modal.classList.remove("hidden");

      const content = modal.querySelector(".modal-content");
      if (content) {
        content.classList.add("neon-pop");
        content.addEventListener("animationend", () => {
          content.classList.remove("neon-pop");
        }, { once: true });
      }

      copyBtn.onclick = () => {
        textArea.select();
        navigator.clipboard.writeText(textArea.value).then(() => {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = "Copied!";
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 2000);
        });
      };

      deleteBtn.onclick = async () => {
        if (!confirm("Are you sure you want to delete this document summary?")) return;
        // Logic to delete summary (update project with empty summary)
        try {
          // We reuse the update endpoint or create a specific one. 
          // Since we don't have a specific 'delete summary' endpoint, we can update the project doc_summary to empty string via update endpoint if we exposed it, 


          // --- Close Modals on Outside Click ---the attach endpoint with empty? No.
          // Let's use the update endpoint if possible, but we need to send doc_summary. 
          // Wait, the update endpoint only updates specific fields.
          // I'll assume for now we can't easily delete it without backend change, 
          // BUT I can add a note or just clear the text area and say "Deleted" locally?
          // The user asked for a delete option. I should have added a backend route.
          // I'll add a backend route for this quickly in the next step or use a workaround.
          // Workaround: Update the project with empty doc_summary. 
          // I'll add a specific route for this in chat_handler.py later if needed, but for now I'll just alert.
          alert("Feature pending backend update. (Please implement /api/dems/projects/<id>/summary/delete)");
        } catch (e) {
          alert("Error: " + e);
        }
      };

      // Actually, I will implement the delete logic properly. 
      // I'll assume I can call an endpoint. I'll add the endpoint in the next step.
      deleteBtn.onclick = async () => {
        if (!confirm("Delete this summary?")) return;
        try {
          const res = await fetch(`/api/dems/projects/${projectId}/summary/delete`, { method: 'POST' });
          if (res.ok) {
            textArea.value = "";
            modal.classList.add("hidden");
            renderAll(); // Refresh
          } else {
            alert("Error deleting summary");
          }
        } catch (e) { console.error(e); }
      };

      closeBtn.onclick = () => {
        modal.classList.add("hidden");
      };
    }

    /* ========= MODAL ANALYSIS ========= */
    function openAnalysisModal(htmlContent) {
      const modal = document.getElementById("analysis-modal");
      const contentDiv = document.getElementById("analysis-content");
      const closeBtn = document.getElementById("close-analysis-modal");

      contentDiv.innerHTML = htmlContent;
      modal.classList.remove("hidden");

      closeBtn.onclick = () => modal.classList.add("hidden");
    }

    /* ========= CREATE PROJECT ========= */
    createProjectBtn.addEventListener('click', async () => {
      const payload = await openProjectForm(null);
      if (!payload) return;

      try {
        const res = await fetch('/api/dems/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.project) {
          activeProjects.push(data.project);
          renderAll();
        } else {
          alert('Error creating project: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Connection error creating DEM: ' + err);
      }
    });

    /* ========= REPORT (PORTFOLIO) ========= */
    generateReportBtn.addEventListener('click', async () => {
      reportOutput.textContent = 'Generating report...';

      // Tomar solo los DEMs activos (NO archivados)
      const activeOnly = activeProjects;  // ya est√°n filtrados desde loadProjects()

      try {
        const res = await fetch('/api/dems/report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projects: activeOnly })  // <‚îÄ‚îÄ SOLO ACTIVOS
        });

        const data = await res.json();

        if (data.report) {
          reportOutput.textContent = data.report;
        } else {
          reportOutput.textContent =
            'Error generating report: ' + (data.error || 'Unknown error');
        }

      } catch (err) {
        reportOutput.textContent = 'Connection error generating report: ' + err;
      }
    });

    /* ========= AMD AI REPORT ========= */
    if (generateAiReportBtn) {
      generateAiReportBtn.addEventListener('click', async () => {
        reportOutput.textContent = '>> INITIALIZING NEURAL LINK...\n>> ANALYZING PROJECT DATA...\n>> GENERATING STRATEGIC ADVICE (SAP 4 HANA / CLOUD)...';

        const activeOnly = activeProjects;

        try {
          const res = await fetch('/api/dems/report/ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ projects: activeOnly })
          });

          const data = await res.json();

          if (data.error) {
            alert('Error: ' + data.error);
            return;
          }

          // Assuming reportOutput is already defined in the outer scope
          reportOutput.innerHTML = data.report; // Use innerHTML for styled reports

          // Scroll to report section
          document.getElementById('dem-report-section').scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
          reportOutput.textContent = '>> CONNECTION ERROR: ' + err;
        }
      });
    }


    async function downloadReport(format) {
      try {
        const res = await fetch('/api/dems/download/' + format);
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          alert('Error downloading report: ' + (data.error || res.statusText));
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dems_portfolio.' + format;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        alert('Connection error downloading report: ' + err);
      }
    }

    downloadTxtBtn.addEventListener('click', () => downloadReport('txt'));
    downloadDocxBtn.addEventListener('click', () => downloadReport('docx'));
    downloadPdfBtn.addEventListener('click', () => downloadReport('pdf'));

    async function exportProjectsJson() {
      try {
        const res = await fetch('/api/dems/export_json');
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          alert('Error exporting projects: ' + (data.error || res.statusText));
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dems_backup.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        alert('Connection error exporting projects: ' + err);
      }
    }

    function handleImportJsonFile(evt) {
      const file = evt.target.files && evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const text = e.target?.result;
          const parsed = typeof text === 'string' ? JSON.parse(text) : null;
          const projects = Array.isArray(parsed) ? parsed : parsed?.projects;
          if (!Array.isArray(projects)) {
            alert('Invalid JSON file. It must be an array of DEM objects or {"projects": [...]}');
            return;
          }
          const res = await fetch('/api/dems/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ projects }),
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            alert('Error importing projects: ' + (data.error || res.statusText));
            return;
          }
          await loadProjects();
          alert('Projects imported successfully.');
        } catch (err) {
          alert('Error reading JSON file: ' + err);
        } finally {
          evt.target.value = '';
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    if (exportJsonBtn) {
      exportJsonBtn.addEventListener('click', exportProjectsJson);
    }
    if (importJsonBtn && importJsonInput) {
      importJsonBtn.addEventListener('click', () => importJsonInput.click());
      importJsonInput.addEventListener('change', handleImportJsonFile);
    }

    /* ========= FILES MODAL ========= */
    const viewFilesBtn = document.getElementById('view-files-btn');
    const filesModal = document.getElementById('files-modal');
    const closeFilesModalBtn = document.getElementById('close-files-modal');
    const filesTableBody = document.querySelector('#files-table tbody');

    if (viewFilesBtn) {
      viewFilesBtn.addEventListener('click', () => {
        console.log('View Files clicked');
        fetch('/api/files')
          .then(r => r.json())
          .then(data => {
            if (data.error) {
              alert('Error: ' + data.error);
              return;
            }
            filesTableBody.innerHTML = '';
            if (data.files && data.files.length > 0) {
              data.files.forEach(f => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${f.name}</td>
                    <td>${f.date}</td>
                    <td>${f.size}</td>
                    <td style="display:flex; gap:8px;">
                      <button class="btn-cyber small" onclick="window.open('/api/files/${f.name}', '_blank')">‚¨á</button>
                      <button class="btn-cyber-red small" onclick="deleteFile('${f.name}')">üóë</button>
                    </td>
                  `;
                filesTableBody.appendChild(tr);
              });
            } else {
              filesTableBody.innerHTML = '<tr><td colspan="4">No files found.</td></tr>';
            }
            filesModal.classList.remove('hidden');
          })
          .catch(err => console.error(err));
      });
    }

    if (closeFilesModalBtn) {
      closeFilesModalBtn.addEventListener('click', () => {
        filesModal.classList.add('hidden');
      });
    }

    async function deleteFile(filename) {
      if (!confirm(`Are you sure you want to delete ${filename}?`)) return;
      try {
        const res = await fetch(`/api/files/${filename}/delete`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          // Refresh list
          document.getElementById('view-files-btn').click();
        } else {
          alert('Error deleting file: ' + (data.error || 'Unknown'));
        }
      } catch (e) {
        alert('Connection error: ' + e);
      }
    }

    /* ========= TABS ========= */
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        renderAll();
      });
    });

    /* ========= SEARCH ========= */
    searchInput.addEventListener('input', () => {
      searchText = searchInput.value.toLowerCase();
      renderAll();
    });

    function getCurrentList() {
      return currentTab === 'active' ? activeProjects : archivedProjects;
    }

    function filterBySearch(list) {
      if (!searchText) return list;
      return list.filter(p => {
        const notesText = (p.notes || []).map(n => {
          if (typeof n === 'string') return n;
          if (n && typeof n === 'object') return `[${n.date || ''}] ${n.text || ''}`;
          return '';
        }).join(' ');

        const fields = [
          p.name,
          p.title,
          p.sponsor,
          p.requester,
          p.ba_owner,
          p.cost_center,
          p.status,
          p.workflow_status,
          p.current_owner,
          p.last_note,
          notesText
        ].join(' ').toLowerCase();

        return fields.includes(searchText);
      });
    }

    function buildChips(list) {
      chipBar.innerHTML = '';
      if (!list.length) return;

      // "Show All" chip
      const allChip = document.createElement('button');
      allChip.className = 'dem-chip active'; // Default active
      allChip.textContent = 'ALL';
      allChip.onclick = () => {
        renderProjects(list); // Show all
        document.querySelectorAll('.dem-chip').forEach(c => c.classList.remove('active'));
        allChip.classList.add('active');
      };
      chipBar.appendChild(allChip);

      list.forEach(p => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'dem-chip';
        chip.textContent = p.name || '(No name)';
        chip.addEventListener('click', () => {
          // Filter to ONLY this project
          renderProjects([p]);
          document.querySelectorAll('.dem-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          allChip.classList.remove('active');
        });
        chipBar.appendChild(chip);
      });
    }

    function renderAll() {
      const list = filterBySearch(getCurrentList());
      buildChips(list);
      renderProjects(list);
      updateNotif();
      renderDashboard();
    }

    function renderDashboard() {
      if (!dashboardContainer) return;

      const active = activeProjects || [];
      if (!active.length) {
        dashboardContainer.innerHTML = "<p class='hint'>No active DEMs registered yet.</p>";
        return;
      }

      let total = active.length;
      let p1 = 0, p2 = 0, p3 = 0, p4 = 0;
      let slaOk = 0, slaBreached = 0;
      let totalDays = 0;
      let activeCount = 0;

      active.forEach(p => {
        const pr = String(p.priority || '2');
        if (pr === '1') p1++;
        else if (pr === '2') p2++;
        else if (pr === '3') p3++;
        else if (pr === '4') p4++;

        if (p.sla_breached) slaBreached++;
        else slaOk++;

        // Calculate active days
        if (p.start_date) {
          const start = new Date(p.start_date);
          const now = new Date();
          const diffTime = Math.abs(now - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          totalDays += diffDays;
          activeCount++;
        }
      });

      const avgDays = activeCount ? Math.round(totalDays / activeCount) : 0;

      // Calculate Status Distribution
      const statusCounts = {};
      active.forEach(p => {
        const s = p.status || 'Unknown';
        statusCounts[s] = (statusCounts[s] || 0) + 1;
      });

      // Sort statuses by count desc
      const sortedStatuses = Object.entries(statusCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5

      let statusHtml = sortedStatuses.map(([k, v]) =>
        `<div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
           <span style="color:var(--neon-cyan)">${k}</span>
           <span style="color:#fff">${v}</span>
         </div>`
      ).join('');

      dashboardContainer.innerHTML = `
      <div class="dem-dash-card">
        <div class="dem-dash-label">Active Projects</div>
        <div class="dem-dash-value">${total}</div>
      </div>
      <div class="dem-dash-card">
        <div class="dem-dash-label">Priority Breakdown</div>
        <div class="dem-dash-value" style="font-size: 16px; line-height: 1.4;">
            <span style="color:#ff2a2a">P1: ${p1}</span> ¬∑ 
            <span style="color:#ffaa00">P2: ${p2}</span> ¬∑ 
            <span style="color:#00f3ff">P3: ${p3}</span> ¬∑ 
            <span style="color:#888">P4: ${p4}</span>
        </div>
      </div>
      <div class="dem-dash-card">
        <div class="dem-dash-label">SLA Status</div>
        <div class="dem-dash-value dem-dash-sla" style="font-size: 20px;">
            <span style="color:#00ff00">OK: ${slaOk}</span> ¬∑ 
            <span style="color:#ff2a2a">Breached: ${slaBreached}</span>
        </div>
      </div>
      <div class="dem-dash-card">
        <div class="dem-dash-label">Avg Active Days</div>
        <div class="dem-dash-value">${avgDays} <span style="font-size:14px; color:#888">days</span></div>
      </div>
      <div class="dem-dash-card" style="grid-column: span 2;">
        <div class="dem-dash-label">Top Statuses</div>
        <div style="margin-top:8px;">${statusHtml}</div>
      </div>
    `;
    }

    /* ========= RENDER PROJECT CARDS ========= */
    function renderProjects(list) {
      projectsContainer.innerHTML = '';
      if (!list.length) {
        projectsContainer.innerHTML = "<p class='hint'>No projects in this view.</p>";
        return;
      }

      list.forEach(p => {
        const card = document.createElement('article');
        card.className = 'dem-card';
        card.dataset.id = p.id;
        if (p.sla_breached) card.classList.add('sla-breached');
        if (p.archived) card.classList.add('archived');

        const header = document.createElement('div');
        header.className = 'dem-card-header';

        const priority = p.priority || '2';
        const priorityClass = 'dem-tag priority-badge priority-' + priority;

        header.innerHTML = `
        <div>
          <h3>${p.name || '(No name)'}</h3>
          <p class="dem-subtitle">
            ${p.title || ''}
            ${p.last_note ? '<span class="dem-note-dot" title="Recent updates"></span>' : ''}
          </p>
        </div>
        <div class="dem-tags">
          <span class="dem-tag primary">${p.status || 'N/A'}</span>
          <span class="dem-tag">${p.workflow_status || ''}</span>
          <span class="dem-tag ${p.sla_breached ? 'sla-breached' : 'sla-ok'}">
            ${p.sla_breached ? 'SLA Breached' : 'SLA OK'}
          </span>
          <span class="${priorityClass}">
            Priority ${priority}
          </span>
        </div>
      `;
        card.appendChild(header);

        const meta = document.createElement('div');
        meta.className = 'dem-meta';
        meta.innerHTML = `
        <p><strong>Sponsor:</strong> ${p.sponsor || '-'}</p>
        <p><strong>Requester:</strong> ${p.requester || '-'}</p>
        <p><strong>BA Owner:</strong> ${p.ba_owner || '-'}</p>
        <p><strong>Current Task Owner:</strong> ${p.current_owner || '-'}</p>
        <p><strong>Cost Center:</strong> ${p.cost_center || '-'}</p>
        <p><strong>Start Date:</strong> ${p.start_date || '-'}</p>
        <p><strong>Duration (days):</strong> ${p.duration_days ?? '-'}</p>
        <p><strong>Priority (1‚Äì4):</strong> ${p.priority || '2'}</p>
      `;
        card.appendChild(meta);

        const lastNote = document.createElement('div');
        lastNote.className = 'dem-last-note';
        lastNote.innerHTML = `
        <strong>Last Note:</strong>
        <p>${p.last_note || 'No notes yet.'}</p>
      `;
        card.appendChild(lastNote);

        /* ----- √öNICO NOTES TIMELINE (CON EDIT / DELETE) ----- */
        if (p.notes && p.notes.length > 0) {
          const notesBox = document.createElement("div");
          notesBox.className = "notes-timeline-box";

          notesBox.innerHTML = `
          <div class="notes-title">
            <span>‚ú¶</span> Notes Timeline (Newest First)
          </div>
        `;

          const ulTop = document.createElement("ul");
          ulTop.className = "notes-timeline-list";

          const notesArray = p.notes || [];

          notesArray
            .map((n, i) => ({ data: n, index: i }))
            .reverse()
            .forEach(note => {
              const li = document.createElement("li");
              li.className = "note-item";

              let textLine = "";
              if (typeof note.data === "string") {
                textLine = note.data;
              } else if (note.data && typeof note.data === "object") {
                textLine = `[${note.data.date || ''}] ‚Äî ${note.data.text || ''}`;
              }

              li.innerHTML = `
              <span>${textLine}</span>
              <div class="note-actions">
                <button type="button" class="edit-note-btn btn-cyber-clear" title="Edit note" style="padding: 8px 16px; font-size: 14px;">EDIT ‚úé</button>
                <button type="button" class="delete-note-btn btn-cyber-clear" title="Delete note" style="padding: 8px 16px; font-size: 14px;">DELETE üóë</button>
              </div>
            `;

              li.querySelector(".edit-note-btn").addEventListener("click", () => {
                editNote(p.id, note.index, textLine);
              });

              li.querySelector(".delete-note-btn").addEventListener("click", () => {
                deleteNote(p.id, note.index);
              });

              ulTop.appendChild(li);
            });

          notesBox.appendChild(ulTop);
          card.appendChild(notesBox);
        }

        const banner = document.createElement('div');
        banner.className = 'dem-sla-banner ' + (p.sla_breached ? 'breached' : 'ok');
        banner.textContent = p.sla_breached
          ? 'SLA Breached ‚Äì please review this DEM as soon as possible.'
          : 'SLA OK ‚Äì project updated recently.';
        card.appendChild(banner);

        /* ----- ACTION BUTTONS (CON IA) ----- */
        const actions = document.createElement('div');
        actions.className = 'dem-actions';

        const addNoteBtn = document.createElement('button');
        addNoteBtn.type = 'button';
        addNoteBtn.textContent = 'Add Note';
        addNoteBtn.addEventListener('click', () => addNote(p.id));

        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        // fileInput.accept = '*'; // Allow all
        fileInput.style.display = 'none';
        fileInput.addEventListener('change', () => {
          if (fileInput.files && fileInput.files.length) {
            uploadDoc(p.id, fileInput.files[0]);
          }
        });

        const attachBtn = document.createElement('button');
        attachBtn.type = 'button';
        attachBtn.textContent = 'Attach Doc & Analyze';
        attachBtn.addEventListener('click', () => fileInput.click());

        const viewSummaryBtn = document.createElement('button');
        viewSummaryBtn.type = 'button';
        viewSummaryBtn.textContent = 'View Document Summary';
        viewSummaryBtn.addEventListener('click', () => {
          openSummaryModal(p.doc_summary || 'No document summary stored for this DEM yet.', p.id);
        });

        const analysisBtn = document.createElement('button');
        analysisBtn.type = 'button';
        analysisBtn.textContent = 'AI Solution Analysis';
        analysisBtn.className = 'btn-cyber-red'; // Make it stand out
        analysisBtn.style.fontSize = '10px';
        analysisBtn.addEventListener('click', async () => {
          analysisBtn.textContent = "Analyzing...";
          try {
            const res = await fetch(`/api/dems/project/${p.id}/analysis`, { method: 'POST' });
            const data = await res.json();
            if (data.analysis) {
              openAnalysisModal(marked.parse(data.analysis));
            } else {
              alert("Error: " + (data.error || "Unknown"));
            }
          } catch (e) {
            alert("Connection error: " + e);
          } finally {
            analysisBtn.textContent = 'AI Solution Analysis';
          }
        });

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.textContent = 'Edit Project';
        editBtn.addEventListener('click', () => editProject(p.id));

        const archiveBtn = document.createElement('button');
        archiveBtn.type = 'button';
        archiveBtn.textContent = p.archived ? 'Restore' : 'Archive';
        archiveBtn.classList.add('archive');
        archiveBtn.addEventListener('click', () => toggleArchive(p.id, !!p.archived));

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Delete';
        deleteBtn.classList.add('danger');
        deleteBtn.addEventListener('click', () => deleteProject(p.id));

        actions.appendChild(addNoteBtn);
        actions.appendChild(attachBtn);
        actions.appendChild(viewSummaryBtn);
        actions.appendChild(analysisBtn);
        actions.appendChild(editBtn);
        actions.appendChild(archiveBtn);
        actions.appendChild(deleteBtn);
        actions.appendChild(fileInput);

        card.appendChild(actions);
        projectsContainer.appendChild(card);
      });
    }

    function updateNotif() {
      const totalActiveSla = activeProjects.filter(p => p.sla_breached).length;
      if (totalActiveSla > 0) {
        notif.textContent = `‚óè ${totalActiveSla} DEM(s) with SLA breached`;
      } else {
        notif.textContent = '‚óè All active DEMs within SLA window';
      }
    }

    /* ========= NOTES HANDLERS ========= */
    async function addNote(projectId) {
      const text = prompt("Enter your update note:");
      if (!text) return;

      const timestamp = new Date().toISOString().slice(0, 16).replace("T", " ");
      const notePayload = `[${timestamp}] ‚Äî ${text}`;

      try {
        const res = await fetch(`/api/dems/projects/${projectId}/note`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: notePayload })
        });

        const data = await res.json();

        if (data.project) {
          replaceProject(data.project);
          renderAll();
        } else {
          alert("Error saving note: " + (data.error || "Unknown"));
        }
      } catch (err) {
        alert("Connection error saving note: " + err);
      }
    }

    async function editNote(projectId, noteIndex, oldText) {
      const newText = prompt("Edit note:", oldText);
      if (!newText || newText.trim() === oldText.trim()) return;

      try {
        const res = await fetch(`/api/dems/projects/${projectId}/note/edit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ index: noteIndex, text: newText })
        });

        const data = await res.json();

        if (data.project) {
          replaceProject(data.project);
          renderAll();
        } else {
          alert("Error editing note: " + (data.error || "Unknown"));
        }
      } catch (err) {
        alert("Connection error editing note: " + err);
      }
    }

    async function deleteNote(projectId, noteIndex) {
      if (!confirm("Delete this note?")) return;

      try {
        const res = await fetch(`/api/dems/projects/${projectId}/note/delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ index: noteIndex })
        });

        const data = await res.json();

        if (data.project) {
          replaceProject(data.project);
          renderAll();
        } else {
          alert("Error deleting note: " + (data.error || "Unknown"));
        }
      } catch (err) {
        alert("Connection error deleting note: " + err);
      }
    }

    /* ========= EDIT / ARCHIVE / DELETE PROJECT ========= */
    async function editProject(projectId) {
      const project = [...activeProjects, ...archivedProjects].find(p => p.id === projectId);
      if (!project) return;
      const updated = await openProjectForm(project);
      if (!updated) return;
      try {
        const res = await fetch(`/api/dems/projects/${projectId}/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated)
        });
        const data = await res.json();
        if (data.project) {
          replaceProject(data.project);
          renderAll();
        } else {
          alert('Error updating project: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Connection error updating project: ' + err);
      }
    }

    async function uploadDoc(projectId, file) {
      const fd = new FormData();
      fd.append('file', file);

      alert('Uploading document and generating AI summary. This can take a few seconds.');

      try {
        const res = await fetch(`/api/dems/projects/${projectId}/attach`, {
          method: 'POST',
          body: fd
        });
        const data = await res.json();
        if (data.project) {
          replaceProject(data.project);
          renderAll();
          alert("Summary generated for this DEM.\n\nYou can view it with 'View Document Summary'.");
        } else {
          alert('Error attaching document: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Connection error attaching document: ' + err);
      }
    }

    async function toggleArchive(projectId, currentlyArchived) {
      const url = currentlyArchived
        ? `/api/dems/projects/${projectId}/restore`
        : `/api/dems/projects/${projectId}/archive`;
      try {
        const res = await fetch(url, { method: 'POST' });
        const data = await res.json();
        if (data.project) {
          replaceProject(data.project);
          renderAll();
        } else {
          alert('Error updating archive status: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Connection error updating archive status: ' + err);
      }
    }

    async function deleteProject(projectId) {
      if (!confirm('Delete this DEM permanently?')) return;
      try {
        const res = await fetch(`/api/dems/projects/${projectId}/delete`, {
          method: 'POST'
        });
        const data = await res.json();
        if (data.success) {
          activeProjects = activeProjects.filter(p => p.id !== projectId);
          archivedProjects = archivedProjects.filter(p => p.id !== projectId);
          renderAll();
        } else {
          alert('Error deleting project: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Connection error deleting project: ' + err);
      }
    }

    function replaceProject(updated) {
      activeProjects = activeProjects.map(p => p.id === updated.id ? updated : p);
      archivedProjects = archivedProjects.map(p => p.id === updated.id ? updated : p);
      if (updated.archived) {
        activeProjects = activeProjects.filter(p => p.id !== updated.id);
        if (!archivedProjects.find(p => p.id === updated.id)) {
          archivedProjects.push(updated);
        }
      } else {
        archivedProjects = archivedProjects.filter(p => p.id !== updated.id);
        if (!activeProjects.find(p => p.id === updated.id)) {
          activeProjects.push(updated);
        }
      }
    }

    async function loadProjects() {
      try {
        const resActive = await fetch('/api/dems/projects?archived=false');
        const dataActive = await resActive.json();
        activeProjects = dataActive.projects || [];

        const resArchived = await fetch('/api/dems/projects?archived=true');
        const dataArchived = await resArchived.json();
        archivedProjects = dataArchived.projects || [];

        renderAll();
      } catch (err) {
        projectsContainer.innerHTML = "<p class='hint'>Error loading DEM list: " + err + "</p>";
      }
    }

    /* Trazo de ghost cyberpunk */
    document.addEventListener('mousemove', (e) => {
      const g = document.createElement('div');
      g.classList.add('ghost');
      g.style.left = e.pageX + 'px';
      g.style.top = e.pageY + 'px';
      document.body.appendChild(g);
      setTimeout(() => g.remove(), 600);
    });

    loadProjects();
    /* ========= CURSOR TRAIL ========= */
    document.addEventListener('mousemove', function (e) {
      const trail = document.createElement('div');
      trail.className = 'cursor-trail';
      trail.style.left = e.clientX + 'px';
      trail.style.top = e.clientY + 'px';
      document.body.appendChild(trail);

      setTimeout(() => {
        trail.style.opacity = '0';
        trail.style.transform = 'scale(0.5)';
      }, 50);

      setTimeout(() => {
        trail.remove();
      }, 300);
    });
  </script>
</body>

</html>